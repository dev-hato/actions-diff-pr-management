{"version":3,"file":"schedule-migration.js","sourceRoot":"","sources":["../../../../lib/config/migrations/custom/schedule-migration.ts"],"names":[],"mappings":"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","sourcesContent":["import later from '@breejs/later';\nimport is from '@sindresorhus/is';\nimport { regEx } from '../../../util/regex';\nimport { AbstractMigration } from '../base/abstract-migration';\n\nexport class ScheduleMigration extends AbstractMigration {\n  override readonly propertyName = 'schedule';\n\n  override run(value: unknown): void {\n    if (value) {\n      // massage to array first\n      let schedules: string[] = [];\n      if (is.string(value)) {\n        schedules = [value];\n      }\n      if (Array.isArray(value)) {\n        schedules = [...value];\n      }\n      // split 'and'\n      const schedulesLength = schedules.length;\n      for (let i = 0; i < schedulesLength; i += 1) {\n        if (\n          schedules[i].includes(' and ') &&\n          schedules[i].includes('before ') &&\n          schedules[i].includes('after ')\n        ) {\n          const parsedSchedule = later.parse.text(\n            // We need to massage short hours first before we can parse it\n            schedules[i].replace(regEx(/( \\d?\\d)((a|p)m)/g), '$1:00$2') // TODO #12071\n          ).schedules[0];\n          // Only migrate if the after time is greater than before, e.g. \"after 10pm and before 5am\"\n          if (!parsedSchedule || !parsedSchedule.t_a || !parsedSchedule.t_b) {\n            continue;\n          }\n\n          if (parsedSchedule.t_a[0] > parsedSchedule.t_b[0]) {\n            const toSplit = schedules[i];\n            schedules[i] = toSplit\n              .replace(\n                regEx(\n                  /^(.*?)(after|before) (.*?) and (after|before) (.*?)( |$)(.*)/\n                ), // TODO #12071\n                '$1$2 $3 $7'\n              )\n              .trim();\n            schedules.push(\n              toSplit\n                .replace(\n                  regEx(\n                    /^(.*?)(after|before) (.*?) and (after|before) (.*?)( |$)(.*)/\n                  ), // TODO #12071\n                  '$1$4 $5 $7'\n                )\n                .trim()\n            );\n          }\n        }\n      }\n      for (let i = 0; i < schedules.length; i += 1) {\n        if (schedules[i].includes('on the last day of the month')) {\n          schedules[i] = schedules[i].replace(\n            'on the last day of the month',\n            'on the first day of the month'\n          );\n        }\n        if (schedules[i].includes('on every weekday')) {\n          schedules[i] = schedules[i].replace(\n            'on every weekday',\n            'every weekday'\n          );\n        }\n        if (schedules[i].endsWith(' every day')) {\n          schedules[i] = schedules[i].replace(' every day', '');\n        }\n        if (\n          regEx(/every (mon|tues|wednes|thurs|fri|satur|sun)day$/).test(\n            schedules[i]\n          ) // TODO #12071\n        ) {\n          schedules[i] = schedules[i].replace(\n            regEx(/every ([a-z]*day)$/), // TODO #12071\n            'on $1'\n          );\n        }\n        if (schedules[i].endsWith('days')) {\n          schedules[i] = schedules[i].replace('days', 'day');\n        }\n      }\n      if (is.string(value) && schedules.length === 1) {\n        this.rewrite(schedules[0]);\n      } else {\n        this.rewrite(schedules);\n      }\n    }\n  }\n}\n"]}
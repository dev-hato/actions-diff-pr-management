{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/config/presets/bitbucket-server/index.ts"],"names":[],"mappings":";;;AAAA,4CAAyC;AACzC,mFAA8E;AAE9E,0EAG6C;AAE7C,kCAKiB;AAEjB,MAAM,IAAI,GAAG,IAAI,sCAAmB,EAAE,CAAC;AAEhC,KAAK,UAAU,aAAa,CACjC,IAAY,EACZ,QAAgB,EAChB,QAAgB,EAChB,WAA2B;IAE3B,MAAM,CAAC,UAAU,EAAE,cAAc,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IACrD,IAAA,6BAAU,EAAC,QAAQ,CAAC,CAAC;IACrB,IAAI,GAAG,GAAG,yBAAyB,UAAU,UAAU,cAAc,WAAW,QAAQ,cAAc,CAAC;IACvG,IAAI,WAAW,EAAE;QACf,GAAG,IAAI,MAAM,GAAG,kBAAkB,CAAC,WAAW,CAAC,CAAC;KACjD;IAED,IAAI,GAAuB,CAAC;IAC5B,IAAI;QACF,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;KAC/B;IAAC,OAAO,GAAG,EAAE;QACZ,6CAA6C;QAC7C,IAAI,GAAG,YAAY,uCAAiB,EAAE;YACpC,MAAM,GAAG,CAAC;SACX;QACD,eAAM,CAAC,KAAK,CACV,EAAE,UAAU,EAAE,GAAG,CAAC,UAAU,EAAE,GAAG,EAAE,GAAG,QAAQ,GAAG,GAAG,EAAE,EAAE,EACxD,sBAAsB,QAAQ,YAAY,CAC3C,CAAC;QACF,MAAM,IAAI,KAAK,CAAC,2BAAoB,CAAC,CAAC;KACvC;IACD,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,EAAE;QACxB,eAAM,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,GAAG,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,wBAAwB,CAAC,CAAC;QAC/D,MAAM,IAAI,KAAK,CAAC,0BAAmB,CAAC,CAAC;KACtC;IACD,OAAO,IAAA,kBAAW,EAAC,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC;AACjE,CAAC;AAhCD,sCAgCC;AAED,SAAgB,qBAAqB,CACnC,IAAY,EACZ,UAAkB,EAClB,UAA8B,EAC9B,QAAgB,EAChB,GAAmB;IAEnB,OAAO,IAAA,kBAAW,EAAC;QACjB,IAAI;QACJ,UAAU;QACV,UAAU;QACV,QAAQ;QACR,GAAG;QACH,KAAK,EAAE,aAAa;KACrB,CAAC,CAAC;AACL,CAAC;AAfD,sDAeC","sourcesContent":["import { logger } from '../../../logger';\nimport { ExternalHostError } from '../../../types/errors/external-host-error';\nimport type { FileData } from '../../../types/platform/bitbucket-server';\nimport {\n  BitbucketServerHttp,\n  setBaseUrl,\n} from '../../../util/http/bitbucket-server';\nimport type { Preset } from '../types';\nimport {\n  PRESET_DEP_NOT_FOUND,\n  PRESET_INVALID_JSON,\n  fetchPreset,\n  parsePreset,\n} from '../util';\n\nconst http = new BitbucketServerHttp();\n\nexport async function fetchJSONFile(\n  repo: string,\n  fileName: string,\n  endpoint: string,\n  branchOrTag?: string | null\n): Promise<Preset | null> {\n  const [projectKey, repositorySlug] = repo.split('/');\n  setBaseUrl(endpoint);\n  let url = `rest/api/1.0/projects/${projectKey}/repos/${repositorySlug}/browse/${fileName}?limit=20000`;\n  if (branchOrTag) {\n    url += '&at=' + encodeURIComponent(branchOrTag);\n  }\n\n  let res: { body: FileData };\n  try {\n    res = await http.getJson(url);\n  } catch (err) {\n    // istanbul ignore if: not testable with nock\n    if (err instanceof ExternalHostError) {\n      throw err;\n    }\n    logger.debug(\n      { statusCode: err.statusCode, url: `${endpoint}${url}` },\n      `Failed to retrieve ${fileName} from repo`\n    );\n    throw new Error(PRESET_DEP_NOT_FOUND);\n  }\n  if (!res.body.isLastPage) {\n    logger.warn({ size: res.body.size }, 'Renovate config to big');\n    throw new Error(PRESET_INVALID_JSON);\n  }\n  return parsePreset(res.body.lines.map((l) => l.text).join(''));\n}\n\nexport function getPresetFromEndpoint(\n  repo: string,\n  filePreset: string,\n  presetPath: string | undefined,\n  endpoint: string,\n  tag?: string | null\n): Promise<Preset | undefined> {\n  return fetchPreset({\n    repo,\n    filePreset,\n    presetPath,\n    endpoint,\n    tag,\n    fetch: fetchJSONFile,\n  });\n}\n"]}
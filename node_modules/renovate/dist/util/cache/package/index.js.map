{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/util/cache/package/index.ts"],"names":[],"mappings":";;;;AACA,4DAAsC;AACtC,0DAAoC;AACpC,4DAAsC;AAGtC,IAAI,UAAwB,CAAC;AAE7B,SAAS,YAAY,CAAC,SAAiB,EAAE,GAAW;IAClD,OAAO,WAAW,SAAS,KAAK,GAAG,EAAE,CAAC;AACxC,CAAC;AAEM,KAAK,UAAU,GAAG,CACvB,SAAiB,EACjB,GAAW;IAEX,IAAI,CAAC,UAAU,EAAE;QACf,OAAO,SAAS,CAAC;KAClB;IACD,MAAM,SAAS,GAAG,YAAY,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC;IAC/C,IAAI,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,SAAS,EAAE;QACzC,QAAQ,CAAC,GAAG,CAAC,SAAS,EAAE,UAAU,CAAC,GAAG,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC,CAAC;KACzD;IACD,MAAM,MAAM,GAAG,MAAM,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;IAC7C,OAAO,MAAM,CAAC;AAChB,CAAC;AAbD,kBAaC;AAEM,KAAK,UAAU,GAAG,CACvB,SAAiB,EACjB,GAAW,EACX,KAAc,EACd,OAAe;IAEf,IAAI,CAAC,UAAU,EAAE;QACf,OAAO;KACR;IACD,MAAM,SAAS,GAAG,YAAY,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC;IAC/C,QAAQ,CAAC,GAAG,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;IAC/B,MAAM,UAAU,CAAC,GAAG,CAAC,SAAS,EAAE,GAAG,EAAE,KAAK,EAAE,OAAO,CAAC,CAAC;AACvD,CAAC;AAZD,kBAYC;AAEM,KAAK,UAAU,IAAI,CAAC,MAAiB;IAC1C,IAAI,MAAM,CAAC,QAAQ,EAAE;QACnB,MAAM,UAAU,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QACvC,UAAU,GAAG;YACX,GAAG,EAAE,UAAU,CAAC,GAAG;YACnB,GAAG,EAAE,UAAU,CAAC,GAAG;SACpB,CAAC;KACH;SAAM,IAAI,MAAM,CAAC,QAAQ,EAAE;QAC1B,SAAS,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QAChC,UAAU,GAAG;YACX,GAAG,EAAE,SAAS,CAAC,GAAG;YAClB,GAAG,EAAE,SAAS,CAAC,GAAG;SACnB,CAAC;KACH;AACH,CAAC;AAdD,oBAcC;AAEM,KAAK,UAAU,OAAO,CAAC,MAAiB;IAC7C,IAAI,MAAM,EAAE,QAAQ,EAAE;QACpB,MAAM,UAAU,CAAC,GAAG,EAAE,CAAC;KACxB;AACH,CAAC;AAJD,0BAIC","sourcesContent":["import type { AllConfig } from '../../../config/types';\nimport * as memCache from '../memory';\nimport * as fileCache from './file';\nimport * as redisCache from './redis';\nimport type { PackageCache } from './types';\n\nlet cacheProxy: PackageCache;\n\nfunction getGlobalKey(namespace: string, key: string): string {\n  return `global%%${namespace}%%${key}`;\n}\n\nexport async function get<T = any>(\n  namespace: string,\n  key: string\n): Promise<T | undefined> {\n  if (!cacheProxy) {\n    return undefined;\n  }\n  const globalKey = getGlobalKey(namespace, key);\n  if (memCache.get(globalKey) === undefined) {\n    memCache.set(globalKey, cacheProxy.get(namespace, key));\n  }\n  const result = await memCache.get(globalKey);\n  return result;\n}\n\nexport async function set(\n  namespace: string,\n  key: string,\n  value: unknown,\n  minutes: number\n): Promise<void> {\n  if (!cacheProxy) {\n    return;\n  }\n  const globalKey = getGlobalKey(namespace, key);\n  memCache.set(globalKey, value);\n  await cacheProxy.set(namespace, key, value, minutes);\n}\n\nexport async function init(config: AllConfig): Promise<void> {\n  if (config.redisUrl) {\n    await redisCache.init(config.redisUrl);\n    cacheProxy = {\n      get: redisCache.get,\n      set: redisCache.set,\n    };\n  } else if (config.cacheDir) {\n    fileCache.init(config.cacheDir);\n    cacheProxy = {\n      get: fileCache.get,\n      set: fileCache.set,\n    };\n  }\n}\n\nexport async function cleanup(config: AllConfig): Promise<void> {\n  if (config?.redisUrl) {\n    await redisCache.end();\n  }\n}\n"]}
{"version":3,"file":"auth.js","sourceRoot":"","sources":["../../../lib/util/git/auth.ts"],"names":[],"mappings":";;;;AAAA,0EAAwC;AACxC,+CAA6C;AAC7C,yCAAsC;AAEtC,oCAAiC;AAGjC;;;GAGG;AACH,SAAgB,uCAAuC,CACrD,cAAsB,EACtB,EAAE,KAAK,EAAE,QAAQ,EAAE,SAAS,EAAY,EACxC,oBAAwC;IAExC,IAAI,CAAC,KAAK,EAAE;QACV,eAAM,CAAC,IAAI;QACT,sBAAsB;QACtB,6CAA6C,SAAU,qBAAqB,CAC7E,CAAC;QACF,OAAO,EAAE,GAAG,oBAAoB,EAAE,CAAC;KACpC;IAED,iGAAiG;IACjG,MAAM,yBAAyB,GAC7B,oBAAoB,EAAE,gBAAgB,IAAI,OAAO,CAAC,GAAG,CAAC,gBAAgB,CAAC;IACzE,IAAI,cAAc,GAAG,CAAC,CAAC;IACvB,IAAI,yBAAyB,EAAE;QAC7B,mGAAmG;QACnG,cAAc,GAAG,QAAQ,CAAC,yBAAyB,EAAE,EAAE,CAAC,CAAC;QACzD,IAAI,MAAM,CAAC,KAAK,CAAC,cAAc,CAAC,EAAE;YAChC,eAAM,CAAC,IAAI,CACT,oFAAoF,MAAM,CACxF,OAAO,CAAC,GAAG,CAAC,gBAAgB,CAC7B,gBAAgB,CAClB,CAAC;YACF,cAAc,GAAG,CAAC,CAAC;SACpB;KACF;IAED,MAAM,mBAAmB,GAAG,+BAA+B,CACzD,cAAc,EACd,QAAQ,EACR,KAAK,CACN,CAAC;IAEF,0GAA0G;IAC1G,gFAAgF;IAChF,0EAA0E;IAC1E,MAAM,uBAAuB,GAAG;QAC9B,GAAG,oBAAoB;KACxB,CAAC;IACF,KAAK,MAAM,IAAI,IAAI,mBAAmB,EAAE;QACtC,uBAAuB,CACrB,kBAAkB,cAAc,EAAE,CACnC,GAAG,OAAO,IAAI,CAAC,GAAG,YAAY,CAAC;QAChC,uBAAuB,CAAC,oBAAoB,cAAc,EAAE,CAAC;YAC3D,IAAI,CAAC,SAAS,CAAC;QACjB,cAAc,EAAE,CAAC;KAClB;IACD,uBAAuB,CAAC,kBAAkB,CAAC,GAAG,cAAc,CAAC,QAAQ,EAAE,CAAC;IAExE,OAAO,uBAAuB,CAAC;AACjC,CAAC;AArDD,0FAqDC;AAED,SAAS,+BAA+B,CACtC,GAAW,EACX,QAA4B,EAC5B,SAAiB;IAEjB,IAAI,KAAK,GAAG,SAAS,CAAC;IACtB,IAAI,QAAQ,KAAK,sBAAU,CAAC,MAAM,EAAE;QAClC,KAAK,GAAG,mBAAmB,SAAS,EAAE,CAAC;KACxC;IACD,OAAO,sBAAsB,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;AAC5C,CAAC;AAED;;;GAGG;AACH,SAAgB,sBAAsB,CACpC,MAAc,EACd,KAAa;IAEb,MAAM,mBAAmB,GAAG,EAAE,CAAC;IAC/B,MAAM,OAAO,GAAG,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC;IAC5C,MAAM,UAAU,GAAG,IAAA,uBAAW,EAAC,MAAM,CAAC,CAAC;IAEvC,qEAAqE;IACrE,IAAI,UAAU,CAAC,IAAI,IAAI,UAAU,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,UAAU,CAAC,IAAI,EAAE,CAAC,EAAE;QAC1E,UAAU,CAAC,QAAQ,GAAG,UAAU,CAAC,QAAQ,CAAC,SAAS,CACjD,CAAC,EACD,UAAU,CAAC,QAAQ,CAAC,MAAM,GAAG,IAAI,UAAU,CAAC,IAAI,EAAE,CAAC,MAAM,CAC1D,CAAC;KACH;IAED,MAAM,GAAG,GAAG,EAAE,GAAG,UAAU,EAAE,CAAC;IAC9B,MAAM,QAAQ,GAAG,IAAA,aAAK,EAAC,UAAU,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC;QACnD,CAAC,CAAC,GAAG,CAAC,QAAQ;QACd,CAAC,CAAC,OAAO,CAAC;IAEZ,kCAAkC;IAClC,GAAG,CAAC,KAAK,GAAG,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,KAAK,EAAE,CAAC;IAC7C,mBAAmB,CAAC,IAAI,CAAC;QACvB,GAAG,EAAE,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC;QAC3B,qGAAqG;QACrG,+GAA+G;QAC/G,SAAS,EAAE,aAAa,UAAU,CAAC,QAAQ,GACzC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,UAAU,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC,EAC5C,IAAI,UAAU,CAAC,SAAS,GAAG,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE;KACjE,CAAC,CAAC;IAEH,8CAA8C;IAC9C,GAAG,CAAC,KAAK,GAAG,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,KAAK,EAAE,CAAC;IAC7C,mBAAmB,CAAC,IAAI,CAAC;QACvB,GAAG,EAAE,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC;QAC3B,SAAS,EAAE,UAAU,CAAC,QAAQ,CAAC,KAAK,CAAC;KACtC,CAAC,CAAC;IAEH,kDAAkD;IAClD,GAAG,CAAC,KAAK,GAAG,KAAK,CAAC;IAClB,mBAAmB,CAAC,IAAI,CAAC;QACvB,GAAG,EAAE,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC;QAC3B,SAAS,EAAE,UAAU,CAAC,QAAQ,CAAC,QAAQ,CAAC;KACzC,CAAC,CAAC;IAEH,OAAO,mBAAmB,CAAC;AAC7B,CAAC;AA/CD,wDA+CC","sourcesContent":["import gitUrlParse from 'git-url-parse';\nimport { PlatformId } from '../../constants';\nimport { logger } from '../../logger';\nimport type { HostRule } from '../../types';\nimport { regEx } from '../regex';\nimport type { AuthenticationRule } from './types';\n\n/**\n * Add authorization to a Git Url and returns a new environment variables object\n * @returns a new NodeJS.ProcessEnv object without modifying any input parameters\n */\nexport function getGitAuthenticatedEnvironmentVariables(\n  originalGitUrl: string,\n  { token, hostType, matchHost }: HostRule,\n  environmentVariables?: NodeJS.ProcessEnv\n): NodeJS.ProcessEnv {\n  if (!token) {\n    logger.warn(\n      // TODO: types (#7154)\n      `Could not create environment variable for ${matchHost!} as token was empty`\n    );\n    return { ...environmentVariables };\n  }\n\n  // check if the environmentVariables already contain a GIT_CONFIG_COUNT or if the process has one\n  const gitConfigCountEnvVariable =\n    environmentVariables?.GIT_CONFIG_COUNT ?? process.env.GIT_CONFIG_COUNT;\n  let gitConfigCount = 0;\n  if (gitConfigCountEnvVariable) {\n    // passthrough the gitConfigCountEnvVariable environment variable as start value of the index count\n    gitConfigCount = parseInt(gitConfigCountEnvVariable, 10);\n    if (Number.isNaN(gitConfigCount)) {\n      logger.warn(\n        `Found GIT_CONFIG_COUNT env variable, but couldn't parse the value to an integer: ${String(\n          process.env.GIT_CONFIG_COUNT\n        )}. Ignoring it.`\n      );\n      gitConfigCount = 0;\n    }\n  }\n\n  const authenticationRules = getAuthenticationRulesWithToken(\n    originalGitUrl,\n    hostType,\n    token\n  );\n\n  // create a shallow copy of the environmentVariables as base so we don't modify the input parameter object\n  // add the two new config key and value to the returnEnvironmentVariables object\n  // increase the CONFIG_COUNT by one for each rule and add it to the object\n  const newEnvironmentVariables = {\n    ...environmentVariables,\n  };\n  for (const rule of authenticationRules) {\n    newEnvironmentVariables[\n      `GIT_CONFIG_KEY_${gitConfigCount}`\n    ] = `url.${rule.url}.insteadOf`;\n    newEnvironmentVariables[`GIT_CONFIG_VALUE_${gitConfigCount}`] =\n      rule.insteadOf;\n    gitConfigCount++;\n  }\n  newEnvironmentVariables['GIT_CONFIG_COUNT'] = gitConfigCount.toString();\n\n  return newEnvironmentVariables;\n}\n\nfunction getAuthenticationRulesWithToken(\n  url: string,\n  hostType: string | undefined,\n  authToken: string\n): AuthenticationRule[] {\n  let token = authToken;\n  if (hostType === PlatformId.Gitlab) {\n    token = `gitlab-ci-token:${authToken}`;\n  }\n  return getAuthenticationRules(url, token);\n}\n\n/**\n * Generates the authentication rules for later git usage for the given host\n * @link https://coolaj86.com/articles/vanilla-devops-git-credentials-cheatsheet/\n */\nexport function getAuthenticationRules(\n  gitUrl: string,\n  token: string\n): AuthenticationRule[] {\n  const authenticationRules = [];\n  const hasUser = token.split(':').length > 1;\n  const insteadUrl = gitUrlParse(gitUrl);\n\n  // Workaround for https://github.com/IonicaBizau/parse-path/issues/38\n  if (insteadUrl.port && insteadUrl.resource.endsWith(`:${insteadUrl.port}`)) {\n    insteadUrl.resource = insteadUrl.resource.substring(\n      0,\n      insteadUrl.resource.length - `:${insteadUrl.port}`.length\n    );\n  }\n\n  const url = { ...insteadUrl };\n  const protocol = regEx(/^https?$/).test(url.protocol)\n    ? url.protocol\n    : 'https';\n\n  // ssh protocol with user if empty\n  url.token = hasUser ? token : `ssh:${token}`;\n  authenticationRules.push({\n    url: url.toString(protocol),\n    // only edge case, need to stringify ourself because the exact syntax is not supported by the library\n    // https://github.com/IonicaBizau/git-url-parse/blob/246c9119fb42c2ea1c280028fe77c53eb34c190c/lib/index.js#L246\n    insteadOf: `ssh://git@${insteadUrl.resource}${\n      insteadUrl.port ? `:${insteadUrl.port}` : ''\n    }/${insteadUrl.full_name}${insteadUrl.git_suffix ? '.git' : ''}`,\n  });\n\n  // alternative ssh protocol with user if empty\n  url.token = hasUser ? token : `git:${token}`;\n  authenticationRules.push({\n    url: url.toString(protocol),\n    insteadOf: insteadUrl.toString('ssh'),\n  });\n\n  // https protocol with no user as default fallback\n  url.token = token;\n  authenticationRules.push({\n    url: url.toString(protocol),\n    insteadOf: insteadUrl.toString(protocol),\n  });\n\n  return authenticationRules;\n}\n"]}
{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/crate/index.ts"],"names":[],"mappings":"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","sourcesContent":["import hasha from 'hasha';\nimport Git from 'simple-git';\nimport upath from 'upath';\nimport { GlobalConfig } from '../../../config/global';\nimport { logger } from '../../../logger';\nimport * as memCache from '../../../util/cache/memory';\nimport { cache } from '../../../util/cache/package/decorator';\nimport { privateCacheDir, readCacheFile } from '../../../util/fs';\nimport { simpleGitConfig } from '../../../util/git/config';\nimport { newlineRegex, regEx } from '../../../util/regex';\nimport { parseUrl } from '../../../util/url';\nimport * as cargoVersioning from '../../versioning/cargo';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, Release, ReleaseResult } from '../types';\nimport {\n  CrateMetadata,\n  CrateRecord,\n  RegistryFlavor,\n  RegistryInfo,\n} from './types';\n\nexport class CrateDatasource extends Datasource {\n  static readonly id = 'crate';\n\n  constructor() {\n    super(CrateDatasource.id);\n  }\n\n  override defaultRegistryUrls = ['https://crates.io'];\n\n  override defaultVersioning = cargoVersioning.id;\n\n  static readonly CRATES_IO_BASE_URL =\n    'https://raw.githubusercontent.com/rust-lang/crates.io-index/master/';\n\n  static readonly CRATES_IO_API_BASE_URL = 'https://crates.io/api/v1/';\n\n  @cache({\n    namespace: `datasource-${CrateDatasource.id}`,\n    key: ({ registryUrl, packageName }: GetReleasesConfig) =>\n      // TODO: types (#7154)\n      // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n      `${registryUrl}/${packageName}`,\n    cacheable: ({ registryUrl }: GetReleasesConfig) =>\n      CrateDatasource.areReleasesCacheable(registryUrl),\n  })\n  async getReleases({\n    packageName,\n    registryUrl,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    // istanbul ignore if\n    if (!registryUrl) {\n      logger.warn(\n        'crate datasource: No registryUrl specified, cannot perform getReleases'\n      );\n      return null;\n    }\n\n    const registryInfo = await CrateDatasource.fetchRegistryInfo({\n      packageName,\n      registryUrl,\n    });\n    if (!registryInfo) {\n      logger.debug({ registryUrl }, 'Could not fetch registry info');\n      return null;\n    }\n\n    const dependencyUrl = CrateDatasource.getDependencyUrl(\n      registryInfo,\n      packageName\n    );\n\n    const payload = await this.fetchCrateRecordsPayload(\n      registryInfo,\n      packageName\n    );\n    const lines = payload\n      .split(newlineRegex) // break into lines\n      .map((line) => line.trim()) // remove whitespace\n      .filter((line) => line.length !== 0) // remove empty lines\n      .map((line) => JSON.parse(line) as CrateRecord); // parse\n\n    const metadata = await this.getCrateMetadata(registryInfo, packageName);\n\n    const result: ReleaseResult = {\n      dependencyUrl,\n      releases: [],\n    };\n\n    if (metadata?.homepage) {\n      result.homepage = metadata.homepage;\n    }\n\n    if (metadata?.repository) {\n      result.sourceUrl = metadata.repository;\n    }\n\n    result.releases = lines\n      .map((version) => {\n        const release: Release = {\n          version: version.vers,\n        };\n        if (version.yanked) {\n          release.isDeprecated = true;\n        }\n        return release;\n      })\n      .filter((release) => release.version);\n    if (!result.releases.length) {\n      return null;\n    }\n\n    return result;\n  }\n\n  @cache({\n    namespace: `datasource-${CrateDatasource.id}-metadata`,\n    key: (info: RegistryInfo, packageName: string) =>\n      `${info.rawUrl}/${packageName}`,\n    cacheable: (info: RegistryInfo) =>\n      CrateDatasource.areReleasesCacheable(info.rawUrl),\n    ttlMinutes: 24 * 60, // 24 hours\n  })\n  public async getCrateMetadata(\n    info: RegistryInfo,\n    packageName: string\n  ): Promise<CrateMetadata | null> {\n    if (info.flavor !== RegistryFlavor.CratesIo) {\n      return null;\n    }\n\n    // The `?include=` suffix is required to avoid unnecessary database queries\n    // on the crates.io server. This lets us work around the regular request\n    // throttling of one request per second.\n    const crateUrl = `${CrateDatasource.CRATES_IO_API_BASE_URL}crates/${packageName}?include=`;\n\n    logger.debug(\n      { crateUrl, packageName, registryUrl: info.rawUrl },\n      'downloading crate metadata'\n    );\n\n    try {\n      type Response = { crate: CrateMetadata };\n      const response = await this.http.getJson<Response>(crateUrl);\n      return response.body.crate;\n    } catch (err) {\n      logger.warn(\n        { err, packageName, registryUrl: info.rawUrl },\n        'failed to download crate metadata'\n      );\n    }\n\n    return null;\n  }\n\n  public async fetchCrateRecordsPayload(\n    info: RegistryInfo,\n    packageName: string\n  ): Promise<string> {\n    if (info.clonePath) {\n      const path = upath.join(\n        info.clonePath,\n        ...CrateDatasource.getIndexSuffix(packageName)\n      );\n      return readCacheFile(path, 'utf8');\n    }\n\n    if (info.flavor === RegistryFlavor.CratesIo) {\n      const crateUrl =\n        CrateDatasource.CRATES_IO_BASE_URL +\n        CrateDatasource.getIndexSuffix(packageName).join('/');\n      try {\n        return (await this.http.get(crateUrl)).body;\n      } catch (err) {\n        this.handleGenericErrors(err);\n      }\n    }\n    throw new Error(`unsupported crate registry flavor: ${info.flavor}`);\n  }\n\n  /**\n   * Computes the dependency URL for a crate, given\n   * registry information\n   */\n  private static getDependencyUrl(\n    info: RegistryInfo,\n    packageName: string\n  ): string {\n    switch (info.flavor) {\n      case RegistryFlavor.CratesIo:\n        return `https://crates.io/crates/${packageName}`;\n      case RegistryFlavor.Cloudsmith: {\n        // input: https://dl.cloudsmith.io/basic/$org/$repo/cargo/index.git\n        const tokens = info.url.pathname.split('/');\n        const org = tokens[2];\n        const repo = tokens[3];\n        return `https://cloudsmith.io/~${org}/repos/${repo}/packages/detail/cargo/${packageName}`;\n      }\n      default:\n        return `${info.rawUrl}/${packageName}`;\n    }\n  }\n\n  /**\n   * Given a Git URL, computes a semi-human-readable name for a folder in which to\n   * clone the repository.\n   */\n  private static cacheDirFromUrl(url: URL): string {\n    const proto = url.protocol.replace(regEx(/:$/), '');\n    const host = url.hostname;\n    const hash = hasha(url.pathname, {\n      algorithm: 'sha256',\n    }).substring(0, 7);\n\n    return `crate-registry-${proto}-${host}-${hash}`;\n  }\n\n  /**\n   * Fetches information about a registry, by url.\n   * If no url is given, assumes crates.io.\n   * If an url is given, assumes it's a valid Git repository\n   * url and clones it to cache.\n   */\n  private static async fetchRegistryInfo({\n    packageName,\n    registryUrl,\n  }: GetReleasesConfig): Promise<RegistryInfo | null> {\n    // istanbul ignore if\n    if (!registryUrl) {\n      return null;\n    }\n\n    const url = parseUrl(registryUrl);\n    if (!url) {\n      logger.debug({ registryUrl }, 'could not parse registry URL');\n      return null;\n    }\n\n    let flavor: RegistryFlavor;\n    if (url.hostname === 'crates.io') {\n      flavor = RegistryFlavor.CratesIo;\n    } else if (url.hostname === 'dl.cloudsmith.io') {\n      flavor = RegistryFlavor.Cloudsmith;\n    } else {\n      flavor = RegistryFlavor.Other;\n    }\n\n    const registry: RegistryInfo = {\n      flavor,\n      rawUrl: registryUrl,\n      url,\n    };\n\n    if (flavor !== RegistryFlavor.CratesIo) {\n      if (!GlobalConfig.get('allowCustomCrateRegistries')) {\n        logger.warn(\n          'crate datasource: allowCustomCrateRegistries=true is required for registries other than crates.io, bailing out'\n        );\n        return null;\n      }\n\n      const cacheKey = `crate-datasource/registry-clone-path/${registryUrl}`;\n      const cacheKeyForError = `crate-datasource/registry-clone-path/${registryUrl}/error`;\n\n      // We need to ensure we don't run `git clone` in parallel. Therefore we store\n      // a promise of the running operation in the mem cache, which in the end resolves\n      // to the file path of the cloned repository.\n\n      const clonePathPromise: Promise<string> | null = memCache.get(cacheKey);\n      let clonePath: string;\n\n      if (clonePathPromise) {\n        clonePath = await clonePathPromise;\n      } else {\n        clonePath = upath.join(\n          privateCacheDir(),\n          CrateDatasource.cacheDirFromUrl(url)\n        );\n        logger.info(\n          { clonePath, registryUrl },\n          `Cloning private cargo registry`\n        );\n\n        const git = Git({ ...simpleGitConfig(), maxConcurrentProcesses: 1 });\n        const clonePromise = git.clone(registryUrl, clonePath, {\n          '--depth': 1,\n        });\n\n        memCache.set(\n          cacheKey,\n          clonePromise.then(() => clonePath).catch(() => null)\n        );\n\n        try {\n          await clonePromise;\n        } catch (err) {\n          logger.warn(\n            { err, packageName, registryUrl },\n            'failed cloning git registry'\n          );\n          memCache.set(cacheKeyForError, err);\n\n          return null;\n        }\n      }\n\n      if (!clonePath) {\n        const err = memCache.get(cacheKeyForError);\n        logger.warn(\n          { err, packageName, registryUrl },\n          'Previous git clone failed, bailing out.'\n        );\n\n        return null;\n      }\n\n      registry.clonePath = clonePath;\n    }\n\n    return registry;\n  }\n\n  private static areReleasesCacheable(\n    registryUrl: string | undefined\n  ): boolean {\n    // We only cache public releases, we don't want to cache private\n    // cloned data between runs.\n    return registryUrl === 'https://crates.io';\n  }\n\n  public static getIndexSuffix(packageName: string): string[] {\n    const len = packageName.length;\n\n    if (len === 1) {\n      return ['1', packageName];\n    }\n    if (len === 2) {\n      return ['2', packageName];\n    }\n    if (len === 3) {\n      return ['3', packageName[0], packageName];\n    }\n\n    return [packageName.slice(0, 2), packageName.slice(2, 4), packageName];\n  }\n}\n"]}
{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/galaxy/index.ts"],"names":[],"mappings":";;;;AAAA,4CAAyC;AACzC,qEAA8D;AAE9D,8CAA2C;AAI3C,MAAa,gBAAiB,SAAQ,uBAAU;IAG9C;QACE,KAAK,CAAC,gBAAgB,CAAC,EAAE,CAAC,CAAC;QAGX,0BAAqB,GAAG,KAAK,CAAC;QAE9B,wBAAmB,GAAG,CAAC,6BAA6B,CAAC,CAAC;IAJxE,CAAC;IAWD,KAAK,CAAC,WAAW,CAAC,EAChB,WAAW,EACX,WAAW,GACO;QAClB,MAAM,MAAM,GAAG,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QACtC,MAAM,QAAQ,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;QAC3B,MAAM,WAAW,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;QAE9B,sBAAsB;QACtB,4EAA4E;QAC5E,MAAM,YAAY,GAAG,GAAG,WAAW,iCAAiC,QAAQ,SAAS,WAAW,EAAE,CAAC;QACnG,4EAA4E;QAC5E,MAAM,gBAAgB,GAAG,GAAG,WAAW,GAAG,QAAQ,IAAI,WAAW,EAAE,CAAC;QAEpE,IAAI,GAAG,GAAsC,IAAI,CAAC;QAClD,IAAI;YACF,GAAG,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,OAAO,CAAe,YAAY,CAAC,CAAC;SAC3D;QAAC,OAAO,GAAG,EAAE;YACZ,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,CAAC;SAC/B;QAED,MAAM,IAAI,GAAG,GAAG,EAAE,IAAI,CAAC;QAEvB,IAAI,CAAC,IAAI,EAAE;YACT,eAAM,CAAC,IAAI,CACT,EAAE,UAAU,EAAE,WAAW,EAAE,EAC3B,8BAA8B,YAAY,EAAE,CAC7C,CAAC;YACF,OAAO,IAAI,CAAC;SACb;QAED,qBAAqB;QACrB,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE;YAC3B,eAAM,CAAC,IAAI,CACT,EAAE,UAAU,EAAE,WAAW,EAAE,EAC3B,kCAAkC,YAAY,EAAE,CACjD,CAAC;YACF,OAAO,IAAI,CAAC;SACb;QACD,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE;YAC7B,eAAM,CAAC,IAAI,CACT,EAAE,UAAU,EAAE,WAAW,EAAE,EAC3B,4BAA4B,YAAY,EAAE,CAC3C,CAAC;YACF,OAAO,IAAI,CAAC;SACb;QAED,MAAM,YAAY,GAAG,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;QACrC,MAAM,QAAQ,GAAG,YAAY,CAAC,cAAc,CAAC,QAAQ,CAAC;QAEtD,MAAM,MAAM,GAAkB;YAC5B,QAAQ,EAAE,EAAE;SACb,CAAC;QAEF,MAAM,CAAC,aAAa,GAAG,gBAAgB,CAAC;QACxC,MAAM,EAAE,WAAW,EAAE,IAAI,EAAE,WAAW,EAAE,IAAI,EAAE,GAAG,YAAY,CAAC;QAC9D,IAAI,OAAO,IAAI,KAAK,QAAQ,IAAI,OAAO,IAAI,KAAK,QAAQ,EAAE;YACxD,MAAM,CAAC,SAAS,GAAG,sBAAsB,IAAI,IAAI,IAAI,EAAE,CAAC;SACzD;QAED,MAAM,CAAC,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAC5B,CAAC,OAA+C,EAAE,EAAE;YAClD,MAAM,OAAO,GAAY;gBACvB,OAAO,EAAE,OAAO,CAAC,IAAI;gBACrB,gBAAgB,EAAE,OAAO,CAAC,YAAY;aACvC,CAAC;YAEF,OAAO,OAAO,CAAC;QACjB,CAAC,CACF,CAAC;QAEF,OAAO,MAAM,CAAC;IAChB,CAAC;;AAvFe,mBAAE,GAAG,QAAQ,CAAC;AAe9B;IALC,IAAA,iBAAK,EAAC;QACL,SAAS,EAAE,mBAAmB;QAC9B,GAAG,EAAE,CAAC,iBAAoC,EAAE,EAAE,CAC5C,iBAAiB,CAAC,WAAW;KAChC,CAAC;mDAyED;AAxFH,4CAyFC","sourcesContent":["import { logger } from '../../../logger';\nimport { cache } from '../../../util/cache/package/decorator';\nimport type { HttpResponse } from '../../../util/http/types';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, Release, ReleaseResult } from '../types';\nimport type { GalaxyResult } from './types';\n\nexport class GalaxyDatasource extends Datasource {\n  static readonly id = 'galaxy';\n\n  constructor() {\n    super(GalaxyDatasource.id);\n  }\n\n  override readonly customRegistrySupport = false;\n\n  override readonly defaultRegistryUrls = ['https://galaxy.ansible.com/'];\n\n  @cache({\n    namespace: 'datasource-galaxy',\n    key: (getReleasesConfig: GetReleasesConfig) =>\n      getReleasesConfig.packageName,\n  })\n  async getReleases({\n    packageName,\n    registryUrl,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    const lookUp = packageName.split('.');\n    const userName = lookUp[0];\n    const projectName = lookUp[1];\n\n    // TODO: types (#7154)\n    // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n    const galaxyAPIUrl = `${registryUrl}api/v1/roles/?owner__username=${userName}&name=${projectName}`;\n    // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n    const galaxyProjectUrl = `${registryUrl}${userName}/${projectName}`;\n\n    let raw: HttpResponse<GalaxyResult> | null = null;\n    try {\n      raw = await this.http.getJson<GalaxyResult>(galaxyAPIUrl);\n    } catch (err) {\n      this.handleGenericErrors(err);\n    }\n\n    const body = raw?.body;\n\n    if (!body) {\n      logger.warn(\n        { dependency: packageName },\n        `Received invalid data from ${galaxyAPIUrl}`\n      );\n      return null;\n    }\n\n    // istanbul ignore if\n    if (body.results.length > 1) {\n      logger.warn(\n        { dependency: packageName },\n        `Received multiple results from ${galaxyAPIUrl}`\n      );\n      return null;\n    }\n    if (body.results.length === 0) {\n      logger.info(\n        { dependency: packageName },\n        `Received no results from ${galaxyAPIUrl}`\n      );\n      return null;\n    }\n\n    const resultObject = body.results[0];\n    const versions = resultObject.summary_fields.versions;\n\n    const result: ReleaseResult = {\n      releases: [],\n    };\n\n    result.dependencyUrl = galaxyProjectUrl;\n    const { github_user: user, github_repo: repo } = resultObject;\n    if (typeof user === 'string' && typeof repo === 'string') {\n      result.sourceUrl = `https://github.com/${user}/${repo}`;\n    }\n\n    result.releases = versions.map(\n      (version: { name: string; release_date: string }) => {\n        const release: Release = {\n          version: version.name,\n          releaseTimestamp: version.release_date,\n        };\n\n        return release;\n      }\n    );\n\n    return result;\n  }\n}\n"]}
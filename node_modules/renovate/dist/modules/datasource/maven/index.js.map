{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/maven/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { DateTime } from 'luxon';\nimport pAll from 'p-all';\nimport type { XmlDocument } from 'xmldoc';\nimport { logger } from '../../../logger';\nimport * as packageCache from '../../../util/cache/package';\nimport { newlineRegex, regEx } from '../../../util/regex';\nimport { ensureTrailingSlash } from '../../../util/url';\nimport mavenVersion from '../../versioning/maven';\nimport * as mavenVersioning from '../../versioning/maven';\nimport { compare } from '../../versioning/maven/compare';\nimport { Datasource } from '../datasource';\nimport type {\n  GetReleasesConfig,\n  RegistryStrategy,\n  Release,\n  ReleaseResult,\n} from '../types';\nimport { MAVEN_REPO } from './common';\nimport type { MavenDependency, ReleaseMap } from './types';\nimport {\n  checkResource,\n  createUrlForDependencyPom,\n  downloadHttpProtocol,\n  downloadMavenXml,\n  getDependencyInfo,\n  getDependencyParts,\n  getMavenUrl,\n} from './util';\n\nfunction getLatestSuitableVersion(releases: Release[]): string | null {\n  // istanbul ignore if\n  if (!releases?.length) {\n    return null;\n  }\n  const allVersions = releases.map(({ version }) => version);\n  const stableVersions = allVersions.filter((x) => mavenVersion.isStable(x));\n  const versions = stableVersions.length ? stableVersions : allVersions;\n  return versions.reduce((latestVersion, version) =>\n    compare(version, latestVersion) === 1 ? version : latestVersion\n  );\n}\n\nfunction extractVersions(metadata: XmlDocument): string[] {\n  const versions = metadata.descendantWithPath('versioning.versions');\n  const elements = versions?.childrenNamed('version');\n  if (!elements) {\n    return [];\n  }\n  return elements.map((el) => el.val);\n}\n\nconst mavenCentralHtmlVersionRegex = regEx(\n  '^<a href=\"(?<version>[^\"]+)\\\\/\" title=\"(?:[^\"]+)\\\\/\">(?:[^\"]+)\\\\/<\\\\/a>\\\\s+(?<releaseTimestamp>\\\\d\\\\d\\\\d\\\\d-\\\\d\\\\d-\\\\d\\\\d \\\\d\\\\d:\\\\d\\\\d)\\\\s+-$',\n  'i'\n);\n\nexport const defaultRegistryUrls = [MAVEN_REPO];\n\nexport class MavenDatasource extends Datasource {\n  static id = 'maven';\n\n  override readonly defaultRegistryUrls = defaultRegistryUrls;\n\n  override readonly defaultVersioning: string = mavenVersioning.id;\n\n  override readonly registryStrategy: RegistryStrategy = 'merge';\n\n  constructor(id = MavenDatasource.id) {\n    super(id);\n  }\n\n  async fetchReleasesFromMetadata(\n    dependency: MavenDependency,\n    repoUrl: string\n  ): Promise<ReleaseMap> {\n    const metadataUrl = getMavenUrl(dependency, repoUrl, 'maven-metadata.xml');\n\n    const cacheNamespace = 'datasource-maven:metadata-xml';\n    const cacheKey = metadataUrl.toString();\n    const cachedVersions = await packageCache.get<ReleaseMap>(\n      cacheNamespace,\n      cacheKey\n    );\n    /* istanbul ignore if */\n    if (cachedVersions) {\n      return cachedVersions;\n    }\n\n    const { isCacheable, xml: mavenMetadata } = await downloadMavenXml(\n      this.http,\n      metadataUrl\n    );\n    if (!mavenMetadata) {\n      return {};\n    }\n\n    const versions = extractVersions(mavenMetadata);\n    const releaseMap = versions.reduce(\n      (acc, version) => ({ ...acc, [version]: null }),\n      {}\n    );\n    if (isCacheable) {\n      await packageCache.set(cacheNamespace, cacheKey, releaseMap, 30);\n    }\n    return releaseMap;\n  }\n\n  async addReleasesFromIndexPage(\n    inputReleaseMap: ReleaseMap,\n    dependency: MavenDependency,\n    repoUrl: string\n  ): Promise<ReleaseMap> {\n    const cacheNs = 'datasource-maven:index-html-releases';\n    const cacheKey = `${repoUrl}${dependency.dependencyUrl}`;\n    let workingReleaseMap = await packageCache.get<ReleaseMap>(\n      cacheNs,\n      cacheKey\n    );\n    if (!workingReleaseMap) {\n      workingReleaseMap = {};\n      let retryEarlier = false;\n      try {\n        if (repoUrl.startsWith(MAVEN_REPO)) {\n          const indexUrl = getMavenUrl(dependency, repoUrl, 'index.html');\n          const res = await downloadHttpProtocol(this.http, indexUrl);\n          const { body = '' } = res;\n          for (const line of body.split(newlineRegex)) {\n            const match = line.trim().match(mavenCentralHtmlVersionRegex);\n            if (match) {\n              const { version, releaseTimestamp: timestamp } =\n                match?.groups ?? {};\n              if (version && timestamp) {\n                const date = DateTime.fromFormat(\n                  timestamp,\n                  'yyyy-MM-dd HH:mm',\n                  {\n                    zone: 'UTC',\n                  }\n                );\n                if (date.isValid) {\n                  const releaseTimestamp = date.toISO();\n                  workingReleaseMap[version] = { version, releaseTimestamp };\n                }\n              }\n            }\n          }\n        }\n      } catch (err) /* istanbul ignore next */ {\n        retryEarlier = true;\n        logger.debug(\n          { dependency, err },\n          'Failed to get releases from index.html'\n        );\n      }\n      const cacheTTL = retryEarlier ? 60 : 24 * 60;\n      await packageCache.set(cacheNs, cacheKey, workingReleaseMap, cacheTTL);\n    }\n\n    const releaseMap = { ...inputReleaseMap };\n    for (const version of Object.keys(releaseMap)) {\n      releaseMap[version] ||= workingReleaseMap[version] ?? null;\n    }\n\n    return releaseMap;\n  }\n\n  /**\n   *\n   * Double-check releases using HEAD request and\n   * attach timestamps obtained from `Last-Modified` header.\n   *\n   * Example input:\n   *\n   * {\n   *   '1.0.0': {\n   *     version: '1.0.0',\n   *     releaseTimestamp: '2020-01-01T01:00:00.000Z',\n   *   },\n   *   '1.0.1': null,\n   * }\n   *\n   * Example output:\n   *\n   * {\n   *   '1.0.0': {\n   *     version: '1.0.0',\n   *     releaseTimestamp: '2020-01-01T01:00:00.000Z',\n   *   },\n   *   '1.0.1': {\n   *     version: '1.0.1',\n   *     releaseTimestamp: '2021-01-01T01:00:00.000Z',\n   *   }\n   * }\n   *\n   * It should validate `1.0.0` with HEAD request, but leave `1.0.1` intact.\n   *\n   */\n  async addReleasesUsingHeadRequests(\n    inputReleaseMap: ReleaseMap,\n    dependency: MavenDependency,\n    repoUrl: string\n  ): Promise<ReleaseMap> {\n    const releaseMap = { ...inputReleaseMap };\n\n    if (process.env.RENOVATE_EXPERIMENTAL_NO_MAVEN_POM_CHECK) {\n      return releaseMap;\n    }\n\n    const cacheNs = 'datasource-maven:head-requests';\n    const cacheTimeoutNs = 'datasource-maven:head-requests-timeout';\n    const cacheKey = `${repoUrl}${dependency.dependencyUrl}`;\n\n    // Store cache validity as the separate flag.\n    // This allows both cache updating and resetting.\n    //\n    // Even if new version is being released each 10 minutes,\n    // we still want to reset the whole cache after 24 hours.\n    const isCacheValid = await packageCache.get<true>(cacheTimeoutNs, cacheKey);\n\n    let cachedReleaseMap: ReleaseMap = {};\n    // istanbul ignore if\n    if (isCacheValid) {\n      const cache = await packageCache.get<ReleaseMap>(cacheNs, cacheKey);\n      if (cache) {\n        cachedReleaseMap = cache;\n      }\n    }\n\n    // List versions to check with HEAD request\n    const freshVersions = Object.entries(releaseMap)\n      .filter(([version, release]) => {\n        // Release is present in maven-metadata.xml,\n        // but haven't been validated yet\n        const isValidatedAtPreviousSteps = release !== null;\n\n        // Release was validated and cached with HEAD request during previous run\n        const isValidatedHere = !is.undefined(cachedReleaseMap[version]);\n\n        // Select only valid releases not yet verified with HEAD request\n        return !isValidatedAtPreviousSteps && !isValidatedHere;\n      })\n      .map(([k]) => k);\n\n    // Update cached data with freshly discovered versions\n    if (freshVersions.length) {\n      const queue = freshVersions.map((version) => async (): Promise<void> => {\n        const pomUrl = await createUrlForDependencyPom(\n          this.http,\n          version,\n          dependency,\n          repoUrl\n        );\n        const artifactUrl = getMavenUrl(dependency, repoUrl, pomUrl);\n        const release: Release = { version };\n\n        const res = await checkResource(this.http, artifactUrl);\n\n        if (is.date(res)) {\n          release.releaseTimestamp = res.toISOString();\n        }\n\n        cachedReleaseMap[version] =\n          res !== 'not-found' && res !== 'error' ? release : null;\n      });\n\n      await pAll(queue, { concurrency: 5 });\n\n      if (!isCacheValid) {\n        // Store new TTL flag for 24 hours if the previous one is invalidated\n        await packageCache.set(cacheTimeoutNs, cacheKey, 'long', 24 * 60);\n      }\n\n      // Store updated cache object\n      await packageCache.set(cacheNs, cacheKey, cachedReleaseMap, 24 * 60);\n    }\n\n    // Filter releases with the versions validated via HEAD request\n    for (const version of Object.keys(releaseMap)) {\n      releaseMap[version] = cachedReleaseMap[version] ?? null;\n    }\n    return releaseMap;\n  }\n\n  getReleasesFromMap(releaseMap: ReleaseMap): Release[] {\n    const releases = Object.values(releaseMap).filter(is.truthy);\n    if (releases.length) {\n      return releases;\n    }\n    return Object.keys(releaseMap).map((version) => ({ version }));\n  }\n\n  async getReleases({\n    packageName,\n    registryUrl,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    // istanbul ignore if\n    if (!registryUrl) {\n      return null;\n    }\n\n    const dependency = getDependencyParts(packageName);\n    const repoUrl = ensureTrailingSlash(registryUrl);\n\n    logger.debug(`Looking up ${dependency.display} in repository ${repoUrl}`);\n\n    let releaseMap = await this.fetchReleasesFromMetadata(dependency, repoUrl);\n    releaseMap = await this.addReleasesFromIndexPage(\n      releaseMap,\n      dependency,\n      repoUrl\n    );\n    releaseMap = await this.addReleasesUsingHeadRequests(\n      releaseMap,\n      dependency,\n      repoUrl\n    );\n    const releases = this.getReleasesFromMap(releaseMap);\n    if (!releases?.length) {\n      return null;\n    }\n\n    logger.debug(\n      `Found ${releases.length} new releases for ${dependency.display} in repository ${repoUrl}`\n    );\n\n    const latestSuitableVersion = getLatestSuitableVersion(releases);\n    const dependencyInfo =\n      latestSuitableVersion &&\n      (await getDependencyInfo(\n        this.http,\n        dependency,\n        repoUrl,\n        latestSuitableVersion\n      ));\n\n    return { ...dependency, ...dependencyInfo, releases };\n  }\n}\n"]}
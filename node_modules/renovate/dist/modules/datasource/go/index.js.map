{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/go/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { cache } from '../../../util/cache/package/decorator';\nimport { addSecretForSanitizing } from '../../../util/sanitize';\nimport { parseUrl } from '../../../util/url';\nimport { BitBucketTagsDatasource } from '../bitbucket-tags';\nimport { Datasource } from '../datasource';\nimport { GithubTagsDatasource } from '../github-tags';\nimport { GitlabTagsDatasource } from '../gitlab-tags';\nimport type { DigestConfig, GetReleasesConfig, ReleaseResult } from '../types';\nimport { BaseGoDatasource } from './base';\nimport { GoDirectDatasource } from './releases-direct';\nimport { GoProxyDatasource } from './releases-goproxy';\n\nexport class GoDatasource extends Datasource {\n  static readonly id = 'go';\n\n  constructor() {\n    super(GoDatasource.id);\n  }\n\n  override readonly customRegistrySupport = false;\n\n  readonly goproxy = new GoProxyDatasource();\n  readonly direct = new GoDirectDatasource();\n\n  @cache({\n    namespace: `datasource-${GoDatasource.id}`,\n    // TODO: types (#7154)\n    // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n    key: ({ packageName }: Partial<DigestConfig>) => `${packageName}-digest`,\n  })\n  getReleases(config: GetReleasesConfig): Promise<ReleaseResult | null> {\n    return process.env.GOPROXY\n      ? this.goproxy.getReleases(config)\n      : this.direct.getReleases(config);\n  }\n\n  /**\n   * go.getDigest\n   *\n   * This datasource resolves a go module URL into its source repository\n   *  and then fetches the digest it if it is on GitHub.\n   *\n   * This function will:\n   *  - Determine the source URL for the module\n   *  - Call the respective getDigest in github to retrieve the commit hash\n   */\n  @cache({\n    namespace: GoDatasource.id,\n    key: ({ packageName }: DigestConfig) => `${packageName}-digest`,\n  })\n  override async getDigest(\n    { packageName }: DigestConfig,\n    value?: string | null\n  ): Promise<string | null> {\n    const source = await BaseGoDatasource.getDatasource(packageName);\n    if (!source) {\n      return null;\n    }\n\n    // ignore v0.0.0- pseudo versions that are used Go Modules - look up default branch instead\n    const tag = value && !value.startsWith('v0.0.0-2') ? value : undefined;\n\n    switch (source.datasource) {\n      case GithubTagsDatasource.id: {\n        return this.direct.github.getDigest(source, tag);\n      }\n      case BitBucketTagsDatasource.id: {\n        return this.direct.bitbucket.getDigest?.(source, tag) ?? null;\n      }\n      case GitlabTagsDatasource.id: {\n        return this.direct.gitlab.getDigest?.(source, tag) ?? null;\n      }\n      /* istanbul ignore next: can never happen, makes lint happy */\n      default: {\n        return null;\n      }\n    }\n  }\n}\n\n// istanbul ignore if\nif (is.string(process.env.GOPROXY)) {\n  const uri = parseUrl(process.env.GOPROXY);\n  if (uri?.username) {\n    addSecretForSanitizing(uri.username, 'global');\n  }\n  if (uri?.password) {\n    addSecretForSanitizing(uri.password, 'global');\n  }\n}\n"]}
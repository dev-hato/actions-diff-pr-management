{"version":3,"file":"releases-goproxy.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/go/releases-goproxy.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport moo from 'moo';\nimport pAll from 'p-all';\nimport { logger } from '../../../logger';\nimport { cache } from '../../../util/cache/package/decorator';\nimport { regEx } from '../../../util/regex';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, Release, ReleaseResult } from '../types';\nimport { BaseGoDatasource } from './base';\nimport { GoproxyFallback, getSourceUrl } from './common';\nimport { GoDirectDatasource } from './releases-direct';\nimport type { GoproxyItem, VersionInfo } from './types';\n\nconst parsedGoproxy: Record<string, GoproxyItem[]> = {};\n\nexport class GoProxyDatasource extends Datasource {\n  static readonly id = 'go-proxy';\n\n  constructor() {\n    super(GoProxyDatasource.id);\n  }\n\n  readonly direct = new GoDirectDatasource();\n\n  @cache({\n    namespace: `datasource-${GoProxyDatasource.id}`,\n    key: (config: GetReleasesConfig) => GoProxyDatasource.getCacheKey(config),\n  })\n  async getReleases(config: GetReleasesConfig): Promise<ReleaseResult | null> {\n    const { packageName } = config;\n    logger.trace(`goproxy.getReleases(${packageName})`);\n\n    const goproxy = process.env.GOPROXY;\n    const proxyList = this.parseGoproxy(goproxy);\n    const noproxy = GoProxyDatasource.parseNoproxy();\n\n    let result: ReleaseResult | null = null;\n\n    if (noproxy?.test(packageName)) {\n      logger.debug(`Fetching ${packageName} via GONOPROXY match`);\n      result = await this.direct.getReleases(config);\n      return result;\n    }\n\n    for (const { url, fallback } of proxyList) {\n      try {\n        if (url === 'off') {\n          break;\n        } else if (url === 'direct') {\n          result = await this.direct.getReleases(config);\n          break;\n        }\n\n        const versions = await this.listVersions(url, packageName);\n        const queue = versions.map((version) => async (): Promise<Release> => {\n          try {\n            return await this.versionInfo(url, packageName, version);\n          } catch (err) {\n            logger.trace({ err }, `Can't obtain data from ${url}`);\n            return { version };\n          }\n        });\n        const releases = await pAll(queue, { concurrency: 5 });\n        if (releases.length) {\n          const datasource = await BaseGoDatasource.getDatasource(packageName);\n          const sourceUrl = getSourceUrl(datasource);\n          result = { releases, sourceUrl };\n          break;\n        }\n      } catch (err) {\n        const statusCode = err?.response?.statusCode;\n        const canFallback =\n          fallback === GoproxyFallback.Always\n            ? true\n            : statusCode === 404 || statusCode === 410;\n        const msg = canFallback\n          ? 'Goproxy error: trying next URL provided with GOPROXY'\n          : 'Goproxy error: skipping other URLs provided with GOPROXY';\n        logger.debug({ err }, msg);\n        if (!canFallback) {\n          break;\n        }\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Parse `GOPROXY` to the sequence of url + fallback strategy tags.\n   *\n   * @example\n   * parseGoproxy('foo.example.com|bar.example.com,baz.example.com')\n   * // [\n   * //   { url: 'foo.example.com', fallback: '|' },\n   * //   { url: 'bar.example.com', fallback: ',' },\n   * //   { url: 'baz.example.com', fallback: '|' },\n   * // ]\n   *\n   * @see https://golang.org/ref/mod#goproxy-protocol\n   */\n  parseGoproxy(input: string | undefined = process.env.GOPROXY): GoproxyItem[] {\n    if (!is.string(input)) {\n      return [];\n    }\n\n    if (parsedGoproxy[input]) {\n      return parsedGoproxy[input];\n    }\n\n    const result: GoproxyItem[] = input\n      .split(regEx(/([^,|]*(?:,|\\|))/))\n      .filter(Boolean)\n      .map((s) => s.split(/(?=,|\\|)/)) // TODO: #12872 lookahead\n      .map(([url, separator]) => ({\n        url,\n        fallback:\n          separator === ','\n            ? GoproxyFallback.WhenNotFoundOrGone\n            : GoproxyFallback.Always,\n      }));\n\n    parsedGoproxy[input] = result;\n    return result;\n  }\n  // https://golang.org/pkg/path/#Match\n  static lexer = moo.states({\n    main: {\n      separator: {\n        match: /\\s*?,\\s*?/, // TODO #12870\n        value: (_: string) => '|',\n      },\n      asterisk: {\n        match: '*',\n        value: (_: string) => '[^\\\\/]*',\n      },\n      qmark: {\n        match: '?',\n        value: (_: string) => '[^\\\\/]',\n      },\n      characterRangeOpen: {\n        match: '[',\n        push: 'characterRange',\n        value: (_: string) => '[',\n      },\n      trailingSlash: {\n        match: /\\/$/,\n        value: (_: string) => '',\n      },\n      char: {\n        match: /[^*?\\\\[\\n]/,\n        value: (s: string) => s.replace(regEx('\\\\.', 'g'), '\\\\.'),\n      },\n      escapedChar: {\n        match: /\\\\./, // TODO #12870\n        value: (s: string) => s.slice(1),\n      },\n    },\n    characterRange: {\n      char: /[^\\\\\\]\\n]/, // TODO #12870\n      escapedChar: {\n        match: /\\\\./, // TODO #12870\n        value: (s: string) => s.slice(1),\n      },\n      characterRangeEnd: {\n        match: ']',\n        pop: 1,\n      },\n    },\n  });\n\n  static parsedNoproxy: Record<string, RegExp | null> = {};\n\n  static parseNoproxy(\n    input: unknown = process.env.GONOPROXY ?? process.env.GOPRIVATE\n  ): RegExp | null {\n    if (!is.string(input)) {\n      return null;\n    }\n    if (this.parsedNoproxy[input] !== undefined) {\n      return this.parsedNoproxy[input];\n    }\n    this.lexer.reset(input);\n    const noproxyPattern = [...this.lexer].map(({ value }) => value).join('');\n    const result = noproxyPattern\n      ? regEx(`^(?:${noproxyPattern})(?:/.*)?$`)\n      : null;\n    this.parsedNoproxy[input] = result;\n    return result;\n  }\n\n  /**\n   * Avoid ambiguity when serving from case-insensitive file systems.\n   *\n   * @see https://golang.org/ref/mod#goproxy-protocol\n   */\n  encodeCase(input: string): string {\n    return input.replace(regEx(/([A-Z])/g), (x) => `!${x.toLowerCase()}`);\n  }\n\n  async listVersions(baseUrl: string, packageName: string): Promise<string[]> {\n    const url = `${baseUrl}/${this.encodeCase(packageName)}/@v/list`;\n    const { body } = await this.http.get(url);\n    return body\n      .split(regEx(/\\s+/))\n      .filter(Boolean)\n      .filter((x) => x.indexOf('+') === -1);\n  }\n\n  async versionInfo(\n    baseUrl: string,\n    packageName: string,\n    version: string\n  ): Promise<Release> {\n    const url = `${baseUrl}/${this.encodeCase(packageName)}/@v/${version}.info`;\n    const res = await this.http.getJson<VersionInfo>(url);\n\n    const result: Release = {\n      version: res.body.Version,\n    };\n\n    if (res.body.Time) {\n      result.releaseTimestamp = res.body.Time;\n    }\n\n    return result;\n  }\n\n  static getCacheKey({ packageName }: GetReleasesConfig): string {\n    const goproxy = process.env.GOPROXY;\n    const noproxy = GoProxyDatasource.parseNoproxy();\n    // TODO: types (#7154)\n    // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n    return `${packageName}@@${goproxy}@@${noproxy?.toString()}`;\n  }\n}\n"]}
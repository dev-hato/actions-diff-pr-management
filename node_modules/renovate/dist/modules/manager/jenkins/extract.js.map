{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/jenkins/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { load } from 'js-yaml';\nimport { logger } from '../../../logger';\nimport { isSkipComment } from '../../../util/ignore';\nimport { newlineRegex, regEx } from '../../../util/regex';\nimport { JenkinsPluginsDatasource } from '../../datasource/jenkins-plugins';\nimport * as mavenVersioning from '../../versioning/maven';\nimport type { PackageDependency, PackageFile } from '../types';\nimport type { JenkinsPlugin, JenkinsPlugins } from './types';\n\nconst YamlExtension = regEx(/\\.ya?ml$/);\n\nfunction getDependency(plugin: JenkinsPlugin): PackageDependency {\n  const dep: PackageDependency = {\n    datasource: JenkinsPluginsDatasource.id,\n    versioning: mavenVersioning.id,\n    depName: plugin.artifactId,\n  };\n\n  if (plugin.source?.version) {\n    dep.currentValue = plugin.source.version.toString();\n    if (!is.string(plugin.source.version)) {\n      dep.skipReason = 'invalid-version';\n      logger.warn(\n        { dep },\n        'Jenkins plugin dependency version is not a string and will be ignored'\n      );\n    }\n  } else {\n    dep.skipReason = 'no-version';\n  }\n\n  if (\n    plugin.source?.version === 'latest' ||\n    plugin.source?.version === 'experimental' ||\n    plugin.groupId\n  ) {\n    dep.skipReason = 'unsupported-version';\n  }\n\n  if (plugin.source?.url) {\n    dep.skipReason = 'internal-package';\n  }\n\n  if (!dep.skipReason && plugin.renovate?.ignore) {\n    dep.skipReason = 'ignored';\n  }\n\n  logger.debug({ dep }, 'Jenkins plugin dependency');\n  return dep;\n}\n\nfunction extractYaml(content: string): PackageDependency[] {\n  const deps: PackageDependency[] = [];\n\n  try {\n    const doc = load(content, { json: true }) as JenkinsPlugins;\n    if (is.nonEmptyArray(doc?.plugins)) {\n      for (const plugin of doc.plugins) {\n        if (plugin.artifactId) {\n          const dep = getDependency(plugin);\n          deps.push(dep);\n        }\n      }\n    }\n  } catch (err) /* istanbul ignore next */ {\n    logger.warn({ err }, 'Error parsing Jenkins plugins');\n  }\n  return deps;\n}\n\nfunction extractText(content: string): PackageDependency[] {\n  const deps: PackageDependency[] = [];\n  const regex = regEx(\n    /^\\s*(?<depName>[\\d\\w-]+):(?<currentValue>[^#\\s]+)[#\\s]*(?<comment>.*)$/\n  );\n\n  for (const line of content.split(newlineRegex)) {\n    const match = regex.exec(line);\n    if (match?.groups) {\n      const { depName, currentValue, comment } = match.groups;\n      const plugin: JenkinsPlugin = {\n        artifactId: depName,\n        source: {\n          version: currentValue,\n        },\n        renovate: {\n          ignore: isSkipComment(comment),\n        },\n      };\n      const dep = getDependency(plugin);\n      deps.push(dep);\n    }\n  }\n  return deps;\n}\n\nexport function extractPackageFile(\n  content: string,\n  fileName: string\n): PackageFile | null {\n  logger.trace('jenkins.extractPackageFile()');\n  const deps: PackageDependency[] = [];\n\n  if (YamlExtension.test(fileName)) {\n    deps.push(...extractYaml(content));\n  } else {\n    deps.push(...extractText(content));\n  }\n\n  if (deps.length === 0) {\n    return null;\n  }\n  return { deps };\n}\n"]}
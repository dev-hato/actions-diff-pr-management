{"version":3,"file":"pnpm.js","sourceRoot":"","sources":["../../../../../lib/modules/manager/npm/extract/pnpm.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport findPkgs from 'find-packages';\nimport { load } from 'js-yaml';\nimport upath from 'upath';\nimport { GlobalConfig } from '../../../../config/global';\nimport { logger } from '../../../../logger';\nimport {\n  findLocalSiblingOrParent,\n  getSiblingFileName,\n  localPathExists,\n  readLocalFile,\n} from '../../../../util/fs';\nimport type { PackageFile } from '../../types';\nimport type { PnpmWorkspaceFile } from './types';\n\nexport async function extractPnpmFilters(\n  fileName: string\n): Promise<string[] | undefined> {\n  try {\n    // TODO #7154\n    const contents = load((await readLocalFile(fileName, 'utf8'))!, {\n      json: true,\n    }) as PnpmWorkspaceFile;\n    if (\n      !Array.isArray(contents.packages) ||\n      !contents.packages.every((item) => is.string(item))\n    ) {\n      logger.trace(\n        { fileName },\n        'Failed to find required \"packages\" array in pnpm-workspace.yaml'\n      );\n      return undefined;\n    }\n    return contents.packages;\n  } catch (err) {\n    logger.trace({ fileName, err }, 'Failed to parse pnpm-workspace.yaml');\n    return undefined;\n  }\n}\n\nexport async function findPnpmWorkspace(\n  packageFile: string\n): Promise<{ lockFilePath: string; workspaceYamlPath: string } | null> {\n  // search for pnpm-workspace.yaml\n  const workspaceYamlPath = await findLocalSiblingOrParent(\n    packageFile,\n    'pnpm-workspace.yaml'\n  );\n  if (!workspaceYamlPath) {\n    logger.trace(\n      { packageFile },\n      'Failed to locate pnpm-workspace.yaml in a parent directory.'\n    );\n    return null;\n  }\n\n  // search for pnpm-lock.yaml next to pnpm-workspace.yaml\n  const pnpmLockfilePath = getSiblingFileName(\n    workspaceYamlPath,\n    'pnpm-lock.yaml'\n  );\n  if (!(await localPathExists(pnpmLockfilePath))) {\n    logger.trace(\n      { workspaceYamlPath, packageFile },\n      'Failed to find a pnpm-lock.yaml sibling for the workspace.'\n    );\n    return null;\n  }\n\n  return {\n    lockFilePath: pnpmLockfilePath,\n    workspaceYamlPath,\n  };\n}\n\nexport async function detectPnpmWorkspaces(\n  packageFiles: Partial<PackageFile>[]\n): Promise<void> {\n  logger.debug(`Detecting pnpm Workspaces`);\n  const packagePathCache = new Map<string, string[] | null>();\n\n  for (const p of packageFiles) {\n    const { packageFile, pnpmShrinkwrap } = p;\n\n    // check if pnpmShrinkwrap-file has already been provided\n    if (pnpmShrinkwrap) {\n      logger.trace(\n        { packageFile, pnpmShrinkwrap },\n        'Found an existing pnpm shrinkwrap file; skipping pnpm monorepo check.'\n      );\n      continue;\n    }\n\n    // search for corresponding pnpm workspace\n    // TODO #7154\n    const pnpmWorkspace = await findPnpmWorkspace(packageFile!);\n    if (pnpmWorkspace === null) {\n      continue;\n    }\n    const { workspaceYamlPath, lockFilePath } = pnpmWorkspace;\n\n    // check if package matches workspace filter\n    if (!packagePathCache.has(workspaceYamlPath)) {\n      const filters = await extractPnpmFilters(workspaceYamlPath);\n      const { localDir } = GlobalConfig.get();\n      const packages = await findPkgs(\n        upath.dirname(upath.join(localDir, workspaceYamlPath)),\n        { patterns: filters }\n      );\n      const packagePaths = packages.map((pkg) =>\n        upath.join(pkg.dir, 'package.json')\n      );\n      packagePathCache.set(workspaceYamlPath, packagePaths);\n    }\n    const packagePaths = packagePathCache.get(workspaceYamlPath);\n\n    const isPackageInWorkspace = packagePaths?.some((p) =>\n      p.endsWith(packageFile!)\n    );\n\n    if (isPackageInWorkspace) {\n      p.pnpmShrinkwrap = lockFilePath;\n    } else {\n      logger.trace(\n        { packageFile, workspaceYamlPath },\n        `Didn't find the package in the pnpm workspace`\n      );\n    }\n  }\n}\n"]}
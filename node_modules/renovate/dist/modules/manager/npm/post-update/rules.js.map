{"version":3,"file":"rules.js","sourceRoot":"","sources":["../../../../../lib/modules/manager/npm/post-update/rules.ts"],"names":[],"mappings":";;;;AAAA,kEAAkC;AAClC,+EAAyD;AACzD,kDAA+C;AAC/C,oDAAmD;AACnD,8CAAmD;AAOnD,SAAgB,gBAAgB;IAC9B,IAAI,mBAAwB,CAAC;IAE7B,oEAAoE;IACpE,MAAM,sBAAsB,GAAG,EAAE,CAAC;IAClC,MAAM,YAAY,GAAG,SAAS,CAAC,OAAO,CAAC;QACrC,QAAQ,EAAE,KAAK;KAChB,CAAC,CAAC;IACH,KAAK,MAAM,QAAQ,IAAI,YAAY,EAAE;QACnC,IAAI,QAAQ,CAAC,YAAY,EAAE;YACzB,IAAI,GAAG,GAAG,QAAQ,CAAC,SAAS,CAAC;YAC7B,GAAG;gBACD,YAAE,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,IAAA,iBAAW,EAAC,GAAG,CAAC;oBAChC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,IAAA,aAAK,EAAC,UAAU,CAAC,EAAE,EAAE,CAAC;oBACpC,CAAC,CAAC,sBAAsB;wBACtB,4EAA4E;wBAC5E,KAAK,GAAG,GAAG,CAAC;YAClB,IAAI,QAAQ,CAAC,KAAK,EAAE;gBAClB,MAAM,GAAG,GAAG,QAAQ,CAAC,QAAQ,KAAK,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,YAAY,CAAC;gBACnE,sBAAsB,CAAC,IAAI,CAAC,GAAG,GAAG,IAAI,GAAG,IAAI,QAAQ,CAAC,KAAK,EAAE,CAAC,CAAC;gBAC/D,mBAAmB,KAAnB,mBAAmB,GAAK,EAAE,aAAa,EAAE,EAAE,EAAE,EAAC;gBAC9C,IAAI,QAAQ,CAAC,QAAQ,KAAK,OAAO,EAAE;oBACjC,mBAAmB,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG;wBACvC,YAAY,EAAE,QAAQ,CAAC,KAAK;qBAC7B,CAAC;iBACH;qBAAM;oBACL,mBAAmB,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG;wBACvC,YAAY,EAAE,QAAQ,CAAC,KAAK;qBAC7B,CAAC;iBACH;aACF;iBAAM,IAAI,YAAE,CAAC,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,YAAE,CAAC,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE;gBACvE,MAAM,QAAQ,GAAG,IAAA,iBAAQ,EAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;gBAC7C,sBAAsB,CAAC,IAAI,CAAC,GAAG,GAAG,aAAa,QAAQ,CAAC,QAAQ,EAAE,CAAC,CAAC;gBACpE,sBAAsB,CAAC,IAAI,CAAC,GAAG,GAAG,cAAc,QAAQ,EAAE,CAAC,CAAC;gBAC5D,mBAAmB,KAAnB,mBAAmB,GAAK,EAAE,aAAa,EAAE,EAAE,EAAE,EAAC;gBAC9C,mBAAmB,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG;oBACvC,YAAY,EAAE,GAAG,QAAQ,CAAC,QAAQ,IAAI,QAAQ,CAAC,QAAQ,EAAE;iBAC1D,CAAC;aACH;SACF;KACF;IACD,OAAO,EAAE,sBAAsB,EAAE,mBAAmB,EAAE,CAAC;AACzD,CAAC;AA1CD,4CA0CC","sourcesContent":["import is from '@sindresorhus/is';\nimport * as hostRules from '../../../../util/host-rules';\nimport { regEx } from '../../../../util/regex';\nimport { toBase64 } from '../../../../util/string';\nimport { validateUrl } from '../../../../util/url';\n\nexport interface HostRulesResult {\n  additionalNpmrcContent: string[];\n  additionalYarnRcYml?: any;\n}\n\nexport function processHostRules(): HostRulesResult {\n  let additionalYarnRcYml: any;\n\n  // Determine the additional npmrc content to add based on host rules\n  const additionalNpmrcContent = [];\n  const npmHostRules = hostRules.findAll({\n    hostType: 'npm',\n  });\n  for (const hostRule of npmHostRules) {\n    if (hostRule.resolvedHost) {\n      let uri = hostRule.matchHost;\n      uri =\n        is.string(uri) && validateUrl(uri)\n          ? uri.replace(regEx(/^https?:/), '')\n          : // TODO: types (#7154)\n            // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n            `//${uri}/`;\n      if (hostRule.token) {\n        const key = hostRule.authType === 'Basic' ? '_auth' : '_authToken';\n        additionalNpmrcContent.push(`${uri}:${key}=${hostRule.token}`);\n        additionalYarnRcYml ||= { npmRegistries: {} };\n        if (hostRule.authType === 'Basic') {\n          additionalYarnRcYml.npmRegistries[uri] = {\n            npmAuthIdent: hostRule.token,\n          };\n        } else {\n          additionalYarnRcYml.npmRegistries[uri] = {\n            npmAuthToken: hostRule.token,\n          };\n        }\n      } else if (is.string(hostRule.username) && is.string(hostRule.password)) {\n        const password = toBase64(hostRule.password);\n        additionalNpmrcContent.push(`${uri}:username=${hostRule.username}`);\n        additionalNpmrcContent.push(`${uri}:_password=${password}`);\n        additionalYarnRcYml ||= { npmRegistries: {} };\n        additionalYarnRcYml.npmRegistries[uri] = {\n          npmAuthIdent: `${hostRule.username}:${hostRule.password}`,\n        };\n      }\n    }\n  }\n  return { additionalNpmrcContent, additionalYarnRcYml };\n}\n"]}
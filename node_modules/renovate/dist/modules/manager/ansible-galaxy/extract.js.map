{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/ansible-galaxy/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import { logger } from '../../../logger';\nimport { newlineRegex, regEx } from '../../../util/regex';\nimport type { PackageDependency, PackageFile } from '../types';\nimport { extractCollections } from './collections';\nimport { extractCollectionsMetaDataFile } from './collections-metadata';\nimport { extractRoles } from './roles';\n\nexport function getSliceEndNumber(\n  start: number,\n  numberOfLines: number,\n  ...blocks: number[]\n): number {\n  if (start < 0 || start > numberOfLines - 1) {\n    return -1;\n  }\n  let nearestEnd = numberOfLines - 1;\n  for (const blocksKey of blocks) {\n    if (start < blocksKey && blocksKey < nearestEnd) {\n      nearestEnd = blocksKey;\n    }\n  }\n  return nearestEnd;\n}\n\nexport function extractPackageFile(\n  content: string,\n  fileName: string\n): PackageFile | null {\n  logger.trace('ansible-galaxy.extractPackageFile()');\n  const galaxyFileNameRegEx = regEx(/galaxy\\.ya?ml$/);\n  const deps: PackageDependency[] = [];\n  const lines = content.split(newlineRegex);\n\n  try {\n    // if this is a galaxy.yml file we have to interpret the dependencies differently\n    if (galaxyFileNameRegEx.exec(fileName)) {\n      const galaxyDeps = extractCollectionsMetaDataFile(lines);\n      deps.push(...galaxyDeps);\n    } else {\n      // interpret requirements file\n      // check if new or old format is used and save start lines for collection and roles.\n      const positions = {\n        collections: -1,\n        roles: -1,\n      };\n      // find role and collection block\n      lines.forEach((line, index) => {\n        if (regEx(/^collections:/).exec(line)) {\n          positions.collections = index;\n        }\n        if (regEx(/^roles:/).exec(line)) {\n          positions.roles = index;\n        }\n      });\n      if (positions.collections >= 0 || positions.roles >= 0) {\n        // using new format\n        const collectionLines = lines.slice(\n          positions.collections,\n          getSliceEndNumber(\n            positions.collections,\n            lines.length,\n            positions.roles\n          )\n        );\n        const collectionDeps = extractCollections(collectionLines);\n        deps.push(...collectionDeps);\n\n        const roleLines = lines.slice(\n          positions.roles,\n          getSliceEndNumber(\n            positions.roles,\n            lines.length,\n            positions.collections\n          )\n        );\n        const roleDeps = extractRoles(roleLines);\n        deps.push(...roleDeps);\n      } else {\n        // use old format which only has only roles\n        const galaxyDeps = extractRoles(lines);\n        deps.push(...galaxyDeps);\n      }\n    }\n\n    if (!deps.length) {\n      return null;\n    }\n    return { deps };\n  } catch (err) /* istanbul ignore next */ {\n    logger.debug({ err }, 'Error extracting ansible-galaxy deps');\n    return null;\n  }\n}\n"]}
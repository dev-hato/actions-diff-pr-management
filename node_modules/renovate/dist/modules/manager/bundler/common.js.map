{"version":3,"file":"common.js","sourceRoot":"","sources":["../../../../lib/modules/manager/bundler/common.ts"],"names":[],"mappings":";;;AAAA,4CAAyC;AACzC,yCAAqE;AACrE,+CAA4C;AAG/B,QAAA,UAAU,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;AAErC,SAAgB,kBAAkB,CAAC,GAAW;IAC5C,MAAM,SAAS,GAAG,IAAA,aAAK,EAAC,iCAAiC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IACrE,IAAI,SAAS,EAAE,MAAM,KAAK,CAAC,EAAE;QAC3B,OAAO,IAAI,CAAC;KACb;IACD,MAAM,aAAa,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;IACnC,OAAO,aAAa,CAAC,SAAS,CAAC,CAAC,EAAE,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;AAC9D,CAAC;AAPD,gDAOC;AAEM,KAAK,UAAU,iBAAiB,CACrC,cAA8B;IAE9B,MAAM,EAAE,eAAe,EAAE,MAAM,EAAE,qBAAqB,EAAE,GAAG,cAAc,CAAC;IAC1E,MAAM,EAAE,WAAW,GAAG,EAAE,EAAE,GAAG,MAAM,CAAC;IACpC,MAAM,EAAE,IAAI,EAAE,GAAG,WAAW,CAAC;IAE7B,IAAI,IAAI,EAAE;QACR,eAAM,CAAC,KAAK,CAAC,mCAAmC,CAAC,CAAC;QAClD,OAAO,IAAI,CAAC;KACb;SAAM;QACL,MAAM,SAAS,GAAG,kBAAkB,CAAC,qBAAqB,CAAC,CAAC;QAC5D,IAAI,SAAS,EAAE;YACb,eAAM,CAAC,KAAK,CAAC,iCAAiC,CAAC,CAAC;YAChD,OAAO,SAAS,CAAC;SAClB;QACD,MAAM,eAAe,GAAG,IAAA,uBAAkB,EACxC,eAAe,EACf,eAAe,CAChB,CAAC;QACF,MAAM,sBAAsB,GAAG,MAAM,IAAA,kBAAa,EAAC,eAAe,EAAE,MAAM,CAAC,CAAC;QAC5E,IAAI,sBAAsB,EAAE;YAC1B,eAAM,CAAC,KAAK,CAAC,+CAA+C,CAAC,CAAC;YAC9D,OAAO,sBAAsB;iBAC1B,OAAO,CAAC,IAAA,aAAK,EAAC,QAAQ,CAAC,EAAE,EAAE,CAAC;iBAC5B,OAAO,CAAC,IAAA,aAAK,EAAC,KAAK,CAAC,EAAE,EAAE,CAAC;iBACzB,IAAI,EAAE,CAAC;SACX;KACF;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AA9BD,8CA8BC;AAED,SAAgB,oBAAoB,CAClC,cAA8C,EAC9C,uBAA+B;IAE/B,MAAM,EAAE,MAAM,EAAE,GAAG,cAAc,CAAC;IAClC,MAAM,EAAE,WAAW,GAAG,EAAE,EAAE,GAAG,MAAM,CAAC;IACpC,MAAM,EAAE,OAAO,EAAE,GAAG,WAAW,CAAC;IAEhC,IAAI,OAAO,EAAE;QACX,eAAM,CAAC,KAAK,CAAC,sCAAsC,CAAC,CAAC;QACrD,OAAO,OAAO,CAAC;KAChB;SAAM;QACL,MAAM,WAAW,GAAG,IAAA,aAAK,EAAC,gCAAgC,CAAC,CAAC,IAAI,CAC9D,uBAAuB,CACxB,CAAC;QACF,IAAI,WAAW,EAAE;YACf,eAAM,CAAC,KAAK,CAAC,6CAA6C,CAAC,CAAC;YAC5D,OAAO,WAAW,CAAC,CAAC,CAAC,CAAC;SACvB;KACF;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AArBD,oDAqBC","sourcesContent":["import { logger } from '../../../logger';\nimport { getSiblingFileName, readLocalFile } from '../../../util/fs';\nimport { regEx } from '../../../util/regex';\nimport type { UpdateArtifact } from '../types';\n\nexport const delimiters = ['\"', \"'\"];\n\nexport function extractRubyVersion(txt: string): string | null {\n  const rubyMatch = regEx(/^ruby\\s+(\"[^\"]+\"|'[^']+')\\s*$/gm).exec(txt);\n  if (rubyMatch?.length !== 2) {\n    return null;\n  }\n  const quotedVersion = rubyMatch[1];\n  return quotedVersion.substring(1, quotedVersion.length - 1);\n}\n\nexport async function getRubyConstraint(\n  updateArtifact: UpdateArtifact\n): Promise<string | null> {\n  const { packageFileName, config, newPackageFileContent } = updateArtifact;\n  const { constraints = {} } = config;\n  const { ruby } = constraints;\n\n  if (ruby) {\n    logger.debug('Using ruby constraint from config');\n    return ruby;\n  } else {\n    const rubyMatch = extractRubyVersion(newPackageFileContent);\n    if (rubyMatch) {\n      logger.debug('Using ruby version from gemfile');\n      return rubyMatch;\n    }\n    const rubyVersionFile = getSiblingFileName(\n      packageFileName,\n      '.ruby-version'\n    );\n    const rubyVersionFileContent = await readLocalFile(rubyVersionFile, 'utf8');\n    if (rubyVersionFileContent) {\n      logger.debug('Using ruby version specified in .ruby-version');\n      return rubyVersionFileContent\n        .replace(regEx(/^ruby-/), '')\n        .replace(regEx(/\\n/g), '')\n        .trim();\n    }\n  }\n  return null;\n}\n\nexport function getBundlerConstraint(\n  updateArtifact: Pick<UpdateArtifact, 'config'>,\n  existingLockFileContent: string\n): string | null {\n  const { config } = updateArtifact;\n  const { constraints = {} } = config;\n  const { bundler } = constraints;\n\n  if (bundler) {\n    logger.debug('Using bundler constraint from config');\n    return bundler;\n  } else {\n    const bundledWith = regEx(/\\nBUNDLED WITH\\n\\s+(.*?)(\\n|$)/).exec(\n      existingLockFileContent\n    );\n    if (bundledWith) {\n      logger.debug('Using bundler version specified in lockfile');\n      return bundledWith[1];\n    }\n  }\n  return null;\n}\n"]}
{"version":3,"file":"artifacts.js","sourceRoot":"","sources":["../../../../lib/modules/manager/gradle-wrapper/artifacts.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { quote } from 'shlex';\nimport { TEMPORARY_ERROR } from '../../../constants/error-messages';\nimport { logger } from '../../../logger';\nimport { exec } from '../../../util/exec';\nimport type { ExecOptions } from '../../../util/exec/types';\nimport { readLocalFile, writeLocalFile } from '../../../util/fs';\nimport { getRepoStatus } from '../../../util/git';\nimport type { StatusResult } from '../../../util/git/types';\nimport { Http } from '../../../util/http';\nimport { newlineRegex } from '../../../util/regex';\nimport type { UpdateArtifact, UpdateArtifactsResult } from '../types';\nimport {\n  extraEnv,\n  getJavaConstraint,\n  gradleWrapperFileName,\n  prepareGradleCommand,\n} from './utils';\n\nconst http = new Http('gradle-wrapper');\n\nasync function addIfUpdated(\n  status: StatusResult,\n  fileProjectPath: string\n): Promise<UpdateArtifactsResult | null> {\n  if (status.modified.includes(fileProjectPath)) {\n    return {\n      file: {\n        type: 'addition',\n        path: fileProjectPath,\n        contents: await readLocalFile(fileProjectPath),\n      },\n    };\n  }\n  return null;\n}\n\nfunction getDistributionUrl(newPackageFileContent: string): string | null {\n  const distributionUrlLine = newPackageFileContent\n    .split(newlineRegex)\n    .find((line) => line.startsWith('distributionUrl='));\n  if (distributionUrlLine) {\n    return distributionUrlLine\n      .replace('distributionUrl=', '')\n      .replace('https\\\\:', 'https:');\n  }\n  return null;\n}\n\nasync function getDistributionChecksum(url: string): Promise<string> {\n  const { body } = await http.get(`${url}.sha256`);\n  return body;\n}\n\nexport async function updateArtifacts({\n  packageFileName,\n  newPackageFileContent,\n  updatedDeps,\n  config,\n}: UpdateArtifact): Promise<UpdateArtifactsResult[] | null> {\n  try {\n    logger.debug({ updatedDeps }, 'gradle-wrapper.updateArtifacts()');\n    const gradlewFile = gradleWrapperFileName();\n    let cmd = await prepareGradleCommand(gradlewFile, `wrapper`);\n    if (!cmd) {\n      logger.info('No gradlew found - skipping Artifacts update');\n      return null;\n    }\n    const distributionUrl = getDistributionUrl(newPackageFileContent);\n    if (distributionUrl) {\n      cmd += ` --gradle-distribution-url ${distributionUrl}`;\n      if (newPackageFileContent.includes('distributionSha256Sum=')) {\n        //update checksum in case of distributionSha256Sum in properties then run wrapper\n        const checksum = await getDistributionChecksum(distributionUrl);\n        await writeLocalFile(\n          packageFileName,\n          newPackageFileContent.replace(\n            /distributionSha256Sum=.*/,\n            `distributionSha256Sum=${checksum}`\n          )\n        );\n        cmd += ` --gradle-distribution-sha256-sum ${quote(checksum)}`;\n      }\n    } else {\n      cmd += ` --gradle-version ${quote(config.newValue!)}`;\n    }\n    logger.debug(`Updating gradle wrapper: \"${cmd}\"`);\n    const execOptions: ExecOptions = {\n      docker: {\n        image: 'sidecar',\n      },\n      extraEnv,\n      toolConstraints: [\n        {\n          toolName: 'java',\n          constraint:\n            config.constraints?.java ?? getJavaConstraint(config.currentValue),\n        },\n      ],\n    };\n    try {\n      await exec(cmd, execOptions);\n    } catch (err) {\n      // istanbul ignore if\n      if (err.message === TEMPORARY_ERROR) {\n        throw err;\n      }\n      logger.warn(\n        { err },\n        'Error executing gradle wrapper update command. It can be not a critical one though.'\n      );\n    }\n    const status = await getRepoStatus();\n    const artifactFileNames = [\n      'gradle/wrapper/gradle-wrapper.properties',\n      'gradle/wrapper/gradle-wrapper.jar',\n      'gradlew',\n      'gradlew.bat',\n    ].map(\n      (filename) =>\n        packageFileName\n          .replace('gradle/wrapper/', '')\n          .replace('gradle-wrapper.properties', '') + filename\n    );\n    const updateArtifactsResult = (\n      await Promise.all(\n        artifactFileNames.map((fileProjectPath) =>\n          addIfUpdated(status, fileProjectPath)\n        )\n      )\n    ).filter(is.truthy);\n    logger.debug(\n      { files: updateArtifactsResult.map((r) => r.file?.path) },\n      `Returning updated gradle-wrapper files`\n    );\n    return updateArtifactsResult;\n  } catch (err) {\n    logger.debug({ err }, 'Error setting new Gradle Wrapper release value');\n    return [\n      {\n        artifactError: {\n          lockFile: packageFileName,\n          stderr: err.message,\n        },\n      },\n    ];\n  }\n}\n"]}
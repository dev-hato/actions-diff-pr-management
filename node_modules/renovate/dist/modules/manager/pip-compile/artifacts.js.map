{"version":3,"file":"artifacts.js","sourceRoot":"","sources":["../../../../lib/modules/manager/pip-compile/artifacts.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { quote, split } from 'shlex';\nimport upath from 'upath';\nimport { TEMPORARY_ERROR } from '../../../constants/error-messages';\nimport { logger } from '../../../logger';\nimport { exec } from '../../../util/exec';\nimport type { ExecOptions } from '../../../util/exec/types';\nimport {\n  deleteLocalFile,\n  readLocalFile,\n  writeLocalFile,\n} from '../../../util/fs';\nimport { getRepoStatus } from '../../../util/git';\nimport { regEx } from '../../../util/regex';\nimport type {\n  UpdateArtifact,\n  UpdateArtifactsConfig,\n  UpdateArtifactsResult,\n} from '../types';\n\nfunction getPythonConstraint(\n  config: UpdateArtifactsConfig\n): string | undefined | null {\n  const { constraints = {} } = config;\n  const { python } = constraints;\n\n  if (python) {\n    logger.debug('Using python constraint from config');\n    return python;\n  }\n\n  return undefined;\n}\n\nfunction getPipToolsConstraint(config: UpdateArtifactsConfig): string {\n  const { constraints = {} } = config;\n  const { pipTools } = constraints;\n\n  if (is.string(pipTools)) {\n    logger.debug('Using pipTools constraint from config');\n    return pipTools;\n  }\n\n  return '';\n}\n\nconst constraintLineRegex = regEx(\n  /^(#.*?\\r?\\n)+# {4}pip-compile(?<arguments>.*?)\\r?\\n/\n);\nconst allowedPipArguments = [\n  '--allow-unsafe',\n  '--generate-hashes',\n  '--no-emit-index-url',\n];\n\nexport function constructPipCompileCmd(\n  content: string,\n  inputFileName: string,\n  outputFileName: string\n): string {\n  const headers = constraintLineRegex.exec(content);\n  const args = ['pip-compile'];\n  if (headers?.groups) {\n    logger.debug({ header: headers[0] }, 'Found pip-compile header');\n    for (const argument of split(headers.groups.arguments)) {\n      if (allowedPipArguments.includes(argument)) {\n        args.push(argument);\n      } else if (argument.startsWith('--output-file=')) {\n        const file = upath.parse(outputFileName).base;\n        if (argument !== `--output-file=${file}`) {\n          // we don't trust the user-supplied output-file argument; use our value here\n          logger.warn(\n            { argument },\n            'pip-compile was previously executed with an unexpected `--output-file` filename'\n          );\n        }\n        args.push(`--output-file=${file}`);\n      } else if (argument.startsWith('--')) {\n        logger.trace(\n          { argument },\n          'pip-compile argument is not (yet) supported'\n        );\n      } else {\n        // ignore position argument (.in file)\n      }\n    }\n  }\n  args.push(upath.parse(inputFileName).base);\n\n  return args.map((argument) => quote(argument)).join(' ');\n}\n\nexport async function updateArtifacts({\n  packageFileName: inputFileName,\n  newPackageFileContent: newInputContent,\n  config,\n}: UpdateArtifact): Promise<UpdateArtifactsResult[] | null> {\n  const outputFileName = inputFileName.replace(regEx(/(\\.in)?$/), '.txt');\n  logger.debug(\n    `pipCompile.updateArtifacts(${inputFileName}->${outputFileName})`\n  );\n  const existingOutput = await readLocalFile(outputFileName, 'utf8');\n  if (!existingOutput) {\n    logger.debug('No pip-compile output file found');\n    return null;\n  }\n  try {\n    await writeLocalFile(inputFileName, newInputContent);\n    if (config.isLockFileMaintenance) {\n      await deleteLocalFile(outputFileName);\n    }\n    const cmd = constructPipCompileCmd(\n      existingOutput,\n      inputFileName,\n      outputFileName\n    );\n    const tagConstraint = getPythonConstraint(config);\n    const pipToolsConstraint = getPipToolsConstraint(config);\n    const execOptions: ExecOptions = {\n      cwdFile: inputFileName,\n      docker: {\n        image: 'python',\n        tagConstraint,\n        tagScheme: 'pep440',\n      },\n      preCommands: [\n        `pip install --user ${quote(`pip-tools${pipToolsConstraint}`)}`,\n      ],\n    };\n    logger.debug({ cmd }, 'pip-compile command');\n    await exec(cmd, execOptions);\n    const status = await getRepoStatus();\n    if (!status?.modified.includes(outputFileName)) {\n      return null;\n    }\n    logger.debug('Returning updated pip-compile result');\n    return [\n      {\n        file: {\n          type: 'addition',\n          path: outputFileName,\n          contents: await readLocalFile(outputFileName, 'utf8'),\n        },\n      },\n    ];\n  } catch (err) {\n    // istanbul ignore if\n    if (err.message === TEMPORARY_ERROR) {\n      throw err;\n    }\n    logger.debug({ err }, 'Failed to pip-compile');\n    return [\n      {\n        artifactError: {\n          lockFile: outputFileName,\n          stderr: err.message,\n        },\n      },\n    ];\n  }\n}\n"]}
{"version":3,"file":"util.js","sourceRoot":"","sources":["../../../../lib/modules/manager/nuget/util.ts"],"names":[],"mappings":"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","sourcesContent":["import upath from 'upath';\nimport { XmlDocument } from 'xmldoc';\nimport { logger } from '../../../logger';\nimport { findUpLocal, readLocalFile } from '../../../util/fs';\nimport { regEx } from '../../../util/regex';\nimport { defaultRegistryUrls } from '../../datasource/nuget';\nimport type { Registry } from './types';\n\nexport async function readFileAsXmlDocument(\n  file: string\n): Promise<XmlDocument | undefined> {\n  try {\n    // TODO #7154\n    const doc = new XmlDocument((await readLocalFile(file, 'utf8'))!);\n    // don't return empty documents\n    return doc?.firstChild ? doc : undefined;\n  } catch (err) {\n    logger.debug({ err, file }, `failed to parse file as XML document`);\n    return undefined;\n  }\n}\n\nconst defaultRegistries = defaultRegistryUrls.map(\n  (registryUrl) => ({ url: registryUrl } as Registry)\n);\n\nexport function getDefaultRegistries(): Registry[] {\n  return [...defaultRegistries];\n}\n\nexport async function getConfiguredRegistries(\n  packageFile: string\n): Promise<Registry[] | undefined> {\n  // Valid file names taken from https://github.com/NuGet/NuGet.Client/blob/f64621487c0b454eda4b98af853bf4a528bef72a/src/NuGet.Core/NuGet.Configuration/Settings/Settings.cs#L34\n  const nuGetConfigFileNames = ['nuget.config', 'NuGet.config', 'NuGet.Config'];\n  // normalize paths, otherwise startsWith can fail because of path delimitter mismatch\n  const nuGetConfigPath = await findUpLocal(\n    nuGetConfigFileNames,\n    upath.dirname(packageFile)\n  );\n  if (!nuGetConfigPath) {\n    return undefined;\n  }\n\n  logger.debug({ nuGetConfigPath }, 'found NuGet.config');\n  const nuGetConfig = await readFileAsXmlDocument(nuGetConfigPath);\n  if (!nuGetConfig) {\n    return undefined;\n  }\n\n  const packageSources = nuGetConfig.childNamed('packageSources');\n  if (!packageSources) {\n    return undefined;\n  }\n\n  const registries = getDefaultRegistries();\n  for (const child of packageSources.children) {\n    if (child.type === 'element') {\n      if (child.name === 'clear') {\n        logger.debug(`clearing registry URLs`);\n        registries.length = 0;\n      } else if (child.name === 'add') {\n        const isHttpUrl = regEx(/^https?:\\/\\//i).test(child.attr.value);\n        if (isHttpUrl) {\n          let registryUrl = child.attr.value;\n          if (child.attr.protocolVersion) {\n            registryUrl += `#protocolVersion=${child.attr.protocolVersion}`;\n          }\n          logger.debug({ registryUrl }, 'adding registry URL');\n          registries.push({\n            name: child.attr.key,\n            url: registryUrl,\n          });\n        } else {\n          logger.debug(\n            { registryUrl: child.attr.value },\n            'ignoring local registry URL'\n          );\n        }\n      }\n      // child.name === 'remove' not supported\n    }\n  }\n  return registries;\n}\n"]}
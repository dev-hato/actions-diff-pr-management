{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../lib/modules/manager/terraform/lockfile/index.ts"],"names":[],"mappings":";;;;AAAA,kEAAkC;AAClC,0DAAyB;AACzB,+CAA4C;AAC5C,oDAA2E;AAC3E,+EAAqF;AACrF,oDAA2D;AAE3D,kCAAoD;AACpD,iCAA+C;AAE/C,iCAMgB;AAEhB,KAAK,UAAU,cAAc,CAC3B,KAAqB;IAErB,MAAM,OAAO,GAAG,MAAM,IAAA,eAAI,EACxB,KAAK,EACL,KAAK,EAAE,IAAI,EAAE,EAAE;QACb,MAAM,YAAY,GAAyB;YACzC,UAAU,EAAE,WAAW;YACvB,UAAU,EAAE,oBAAoB;YAChC,OAAO,EAAE,IAAI,CAAC,WAAW;SAC1B,CAAC;QACF,MAAM,EAAE,QAAQ,EAAE,GAAG,CAAC,MAAM,IAAA,2BAAc,EAAC,YAAY,CAAC,CAAC,IAAI,EAAE,CAAC;QAChE,iCAAiC;QACjC,IAAI,CAAC,QAAQ,EAAE;YACb,OAAO,IAAI,CAAC;SACb;QACD,MAAM,UAAU,GAAG,IAAA,gBAAa,EAAC,YAAY,CAAC,UAAU,CAAC,CAAC;QAC1D,MAAM,YAAY,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;QAChE,MAAM,UAAU,GAAG,UAAU,CAAC,oBAAoB,CAChD,YAAY,EACZ,IAAI,CAAC,WAAW,CACjB,CAAC;QAEF,8EAA8E;QAC9E,IAAI,CAAC,UAAU,IAAI,UAAU,KAAK,IAAI,CAAC,OAAO,EAAE;YAC9C,OAAO,IAAI,CAAC;SACb;QACD,MAAM,MAAM,GAAuB;YACjC,UAAU;YACV,aAAa,EAAE,IAAI,CAAC,WAAW;YAC/B,SAAS,EACP,CAAC,MAAM,4BAAqB,CAAC,YAAY,CACvC,IAAI,CAAC,WAAW,EAChB,IAAI,CAAC,WAAW,EAChB,UAAU,CACX,CAAC,IAAI,EAAE;YACV,GAAG,IAAI;SACR,CAAC;QACF,OAAO,MAAM,CAAC;IAChB,CAAC,EACD,EAAE,WAAW,EAAE,CAAC,EAAE,CAAC,sCAAsC;KAC1D,CAAC;IAEF,OAAO,OAAO,CAAC,MAAM,CAAC,YAAE,CAAC,MAAM,CAAC,CAAC;AACnC,CAAC;AAEM,KAAK,UAAU,eAAe,CAAC,EACpC,eAAe,EACf,WAAW,EACX,MAAM,GACS;IACf,eAAM,CAAC,KAAK,CAAC,6BAA6B,eAAe,GAAG,CAAC,CAAC;IAE9D,MAAM,YAAY,GAAG,IAAA,mBAAY,EAAC,eAAe,CAAC,CAAC;IACnD,IAAI;QACF,MAAM,eAAe,GAAG,MAAM,IAAA,mBAAY,EAAC,YAAY,CAAC,CAAC;QACzD,IAAI,CAAC,eAAe,EAAE;YACpB,eAAM,CAAC,KAAK,CAAC,8BAA8B,CAAC,CAAC;YAC7C,OAAO,IAAI,CAAC;SACb;QACD,MAAM,KAAK,GAAG,IAAA,mBAAY,EAAC,eAAe,CAAC,CAAC;QAC5C,IAAI,CAAC,KAAK,EAAE;YACV,eAAM,CAAC,KAAK,CAAC,uCAAuC,CAAC,CAAC;YACtD,OAAO,IAAI,CAAC;SACb;QAED,MAAM,OAAO,GAAyB,EAAE,CAAC;QACzC,IAAI,MAAM,CAAC,UAAU,KAAK,qBAAqB,EAAE;YAC/C,yFAAyF;YACzF,MAAM,kBAAkB,GAAG,MAAM,cAAc,CAAC,KAAK,CAAC,CAAC;YACvD,OAAO,CAAC,IAAI,CAAC,GAAG,kBAAkB,CAAC,CAAC;SACrC;aAAM;YACL,MAAM,YAAY,GAAG,WAAW,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,EAAE;YAC9C,aAAa;YACb,CAAC,UAAU,EAAE,mBAAmB,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAQ,CAAC,CACzD,CAAC;YACF,KAAK,MAAM,GAAG,IAAI,YAAY,EAAE;gBAC9B,IAAA,gCAAyB,EAAC,GAAG,CAAC,CAAC;gBAC/B,MAAM,EAAE,YAAY,EAAE,UAAU,EAAE,QAAQ,EAAE,WAAW,EAAE,GAAG,GAAG,CAAC;gBAEhE,MAAM,WAAW,GAAG,YAAY;oBAC9B,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC;oBACjB,CAAC,CAAC,gDAA2B,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC;gBACvD,MAAM,aAAa,GAAG,IAAA,sBAAe,EAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,QAAQ,CAAC;gBACxE,MAAM,UAAU,GAAG,KAAK,CAAC,IAAI,CAC3B,CAAC,KAAK,EAAE,EAAE,CAAC,KAAK,CAAC,WAAW,KAAK,WAAW,CAC7C,CAAC;gBACF,iCAAiC;gBACjC,IAAI,CAAC,UAAU,EAAE;oBACf,SAAS;iBACV;gBACD,MAAM,MAAM,GAAuB;oBACjC,aAAa;oBACb,UAAU,EAAE,UAAW;oBACvB,aAAa,EAAE,aAAc;oBAC7B,SAAS,EACP,CAAC,MAAM,4BAAqB,CAAC,YAAY,CACvC,WAAW,EACX,UAAU,CAAC,WAAW,EACtB,UAAW,CACZ,CAAC,IAAI,sCAAsC,CAAC,EAAE;oBACjD,GAAG,UAAU;iBACd,CAAC;gBACF,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;aACtB;SACF;QACD,iEAAiE;QACjE,IACE,OAAO,CAAC,MAAM,KAAK,CAAC;YACpB,OAAO,CAAC,IAAI,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC,KAAK,CAAC,SAAS,EAAE,MAAM,CAAC,EACjD;YACA,OAAO,IAAI,CAAC;SACb;QAED,MAAM,GAAG,GAAG,IAAA,uBAAgB,EAAC,OAAO,EAAE,YAAY,EAAE,eAAe,CAAC,CAAC;QACrE,OAAO,CAAC,GAAG,CAAC,CAAC;KACd;IAAC,OAAO,GAAG,EAAE;QACZ,0BAA0B;QAC1B,OAAO;YACL;gBACE,aAAa,EAAE;oBACb,QAAQ,EAAE,YAAY;oBACtB,MAAM,EAAE,GAAG,CAAC,OAAO;iBACpB;aACF;SACF,CAAC;KACH;AACH,CAAC;AAjFD,0CAiFC","sourcesContent":["import is from '@sindresorhus/is';\nimport pMap from 'p-map';\nimport { logger } from '../../../../logger';\nimport { GetPkgReleasesConfig, getPkgReleases } from '../../../datasource';\nimport { TerraformProviderDatasource } from '../../../datasource/terraform-provider';\nimport { get as getVersioning } from '../../../versioning';\nimport type { UpdateArtifact, UpdateArtifactsResult } from '../../types';\nimport { massageProviderLookupName } from '../util';\nimport { TerraformProviderHash } from './hash';\nimport type { ProviderLock, ProviderLockUpdate } from './types';\nimport {\n  extractLocks,\n  findLockFile,\n  isPinnedVersion,\n  readLockFile,\n  writeLockUpdates,\n} from './util';\n\nasync function updateAllLocks(\n  locks: ProviderLock[]\n): Promise<ProviderLockUpdate[]> {\n  const updates = await pMap(\n    locks,\n    async (lock) => {\n      const updateConfig: GetPkgReleasesConfig = {\n        versioning: 'hashicorp',\n        datasource: 'terraform-provider',\n        depName: lock.packageName,\n      };\n      const { releases } = (await getPkgReleases(updateConfig)) ?? {};\n      // istanbul ignore if: needs test\n      if (!releases) {\n        return null;\n      }\n      const versioning = getVersioning(updateConfig.versioning);\n      const versionsList = releases.map((release) => release.version);\n      const newVersion = versioning.getSatisfyingVersion(\n        versionsList,\n        lock.constraints\n      );\n\n      // if the new version is the same as the last, signal that no update is needed\n      if (!newVersion || newVersion === lock.version) {\n        return null;\n      }\n      const update: ProviderLockUpdate = {\n        newVersion,\n        newConstraint: lock.constraints,\n        newHashes:\n          (await TerraformProviderHash.createHashes(\n            lock.registryUrl,\n            lock.packageName,\n            newVersion\n          )) ?? [],\n        ...lock,\n      };\n      return update;\n    },\n    { concurrency: 4 } // allow to look up 4 lock in parallel\n  );\n\n  return updates.filter(is.truthy);\n}\n\nexport async function updateArtifacts({\n  packageFileName,\n  updatedDeps,\n  config,\n}: UpdateArtifact): Promise<UpdateArtifactsResult[] | null> {\n  logger.debug(`terraform.updateArtifacts(${packageFileName})`);\n\n  const lockFilePath = findLockFile(packageFileName);\n  try {\n    const lockFileContent = await readLockFile(lockFilePath);\n    if (!lockFileContent) {\n      logger.debug('No .terraform.lock.hcl found');\n      return null;\n    }\n    const locks = extractLocks(lockFileContent);\n    if (!locks) {\n      logger.debug('No Locks in .terraform.lock.hcl found');\n      return null;\n    }\n\n    const updates: ProviderLockUpdate[] = [];\n    if (config.updateType === 'lockFileMaintenance') {\n      // update all locks in the file during maintenance --> only update version in constraints\n      const maintenanceUpdates = await updateAllLocks(locks);\n      updates.push(...maintenanceUpdates);\n    } else {\n      const providerDeps = updatedDeps.filter((dep) =>\n        // TODO #7154\n        ['provider', 'required_provider'].includes(dep.depType!)\n      );\n      for (const dep of providerDeps) {\n        massageProviderLookupName(dep);\n        const { registryUrls, newVersion, newValue, packageName } = dep;\n\n        const registryUrl = registryUrls\n          ? registryUrls[0]\n          : TerraformProviderDatasource.defaultRegistryUrls[0];\n        const newConstraint = isPinnedVersion(newValue) ? newVersion : newValue;\n        const updateLock = locks.find(\n          (value) => value.packageName === packageName\n        );\n        // istanbul ignore if: needs test\n        if (!updateLock) {\n          continue;\n        }\n        const update: ProviderLockUpdate = {\n          // TODO #7154\n          newVersion: newVersion!,\n          newConstraint: newConstraint!,\n          newHashes:\n            (await TerraformProviderHash.createHashes(\n              registryUrl,\n              updateLock.packageName,\n              newVersion!\n            )) ?? /* istanbul ignore next: needs test */ [],\n          ...updateLock,\n        };\n        updates.push(update);\n      }\n    }\n    // if no updates have been found or there are failed hashes abort\n    if (\n      updates.length === 0 ||\n      updates.some((value) => !value.newHashes?.length)\n    ) {\n      return null;\n    }\n\n    const res = writeLockUpdates(updates, lockFilePath, lockFileContent);\n    return [res];\n  } catch (err) {\n    /* istanbul ignore next */\n    return [\n      {\n        artifactError: {\n          lockFile: lockFilePath,\n          stderr: err.message,\n        },\n      },\n    ];\n  }\n}\n"]}
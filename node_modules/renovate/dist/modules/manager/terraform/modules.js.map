{"version":3,"file":"modules.js","sourceRoot":"","sources":["../../../../lib/modules/manager/terraform/modules.ts"],"names":[],"mappings":"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","sourcesContent":["import { logger } from '../../../logger';\nimport { regEx } from '../../../util/regex';\nimport { BitBucketTagsDatasource } from '../../datasource/bitbucket-tags';\nimport { GitTagsDatasource } from '../../datasource/git-tags';\nimport { GithubTagsDatasource } from '../../datasource/github-tags';\nimport { TerraformModuleDatasource } from '../../datasource/terraform-module';\nimport type { PackageDependency } from '../types';\nimport { TerraformDependencyTypes } from './common';\nimport { extractTerraformProvider } from './providers';\nimport type { ExtractionResult } from './types';\n\nexport const githubRefMatchRegex = regEx(\n  /github\\.com([/:])(?<project>[^/]+\\/[a-z0-9-_.]+).*\\?ref=(?<tag>.*)$/i\n);\nexport const bitbucketRefMatchRegex = regEx(\n  /(?:git::)?(?<url>(?:http|https|ssh)?(?::\\/\\/)?(?:.*@)?(?<path>bitbucket\\.org\\/(?<workspace>.*)\\/(?<project>.*).git\\/?(?<subfolder>.*)))\\?ref=(?<tag>.*)$/\n);\nexport const gitTagsRefMatchRegex = regEx(\n  /(?:git::)?(?<url>(?:(?:http|https|ssh):\\/\\/)?(?:.*@)?(?<path>.*\\/(?<project>.*\\/.*)))\\?ref=(?<tag>.*)$/\n);\nexport const azureDevOpsSshRefMatchRegex = regEx(\n  /(?:git::)?(?<url>git@ssh\\.dev\\.azure\\.com:v3\\/(?<organization>[^/]*)\\/(?<project>[^/]*)\\/(?<repository>[^/]*))(?<modulepath>.*)?\\?ref=(?<tag>.*)$/\n);\nconst hostnameMatchRegex = regEx(/^(?<hostname>([\\w|\\d]+\\.)+[\\w|\\d]+)/);\n\nexport function extractTerraformModule(\n  startingLine: number,\n  lines: string[],\n  moduleName: string\n): ExtractionResult {\n  const result = extractTerraformProvider(startingLine, lines, moduleName);\n  result.dependencies.forEach((dep) => {\n    // TODO #7154\n    dep.managerData!.terraformDependencyType = TerraformDependencyTypes.module;\n  });\n  return result;\n}\n\nexport function analyseTerraformModule(dep: PackageDependency): void {\n  // TODO #7154\n  const source = dep.managerData!.source as string;\n  const githubRefMatch = githubRefMatchRegex.exec(source);\n  const bitbucketRefMatch = bitbucketRefMatchRegex.exec(source);\n  const gitTagsRefMatch = gitTagsRefMatchRegex.exec(source);\n  const azureDevOpsSshRefMatch = azureDevOpsSshRefMatchRegex.exec(source);\n\n  if (githubRefMatch?.groups) {\n    dep.packageName = githubRefMatch.groups.project.replace(\n      regEx(/\\.git$/),\n      ''\n    );\n    dep.depType = 'module';\n    dep.depName = 'github.com/' + dep.packageName;\n    dep.currentValue = githubRefMatch.groups.tag;\n    dep.datasource = GithubTagsDatasource.id;\n  } else if (bitbucketRefMatch?.groups) {\n    dep.depType = 'module';\n    dep.depName =\n      bitbucketRefMatch.groups.workspace +\n      '/' +\n      bitbucketRefMatch.groups.project;\n    dep.packageName = dep.depName;\n    dep.currentValue = bitbucketRefMatch.groups.tag;\n    dep.datasource = BitBucketTagsDatasource.id;\n  } else if (azureDevOpsSshRefMatch?.groups) {\n    dep.depType = 'module';\n    dep.depName = `${azureDevOpsSshRefMatch.groups.organization}/${azureDevOpsSshRefMatch.groups.project}/${azureDevOpsSshRefMatch.groups.repository}${azureDevOpsSshRefMatch.groups.modulepath}`;\n    dep.packageName = azureDevOpsSshRefMatch.groups.url;\n    dep.currentValue = azureDevOpsSshRefMatch.groups.tag;\n    dep.datasource = GitTagsDatasource.id;\n  } else if (gitTagsRefMatch?.groups) {\n    dep.depType = 'module';\n    if (gitTagsRefMatch.groups.path.includes('//')) {\n      logger.debug('Terraform module contains subdirectory');\n      dep.depName = gitTagsRefMatch.groups.path.split('//')[0];\n      const tempLookupName = gitTagsRefMatch.groups.url.split('//');\n      dep.packageName = tempLookupName[0] + '//' + tempLookupName[1];\n    } else {\n      dep.depName = gitTagsRefMatch.groups.path.replace('.git', '');\n      dep.packageName = gitTagsRefMatch.groups.url;\n    }\n    dep.currentValue = gitTagsRefMatch.groups.tag;\n    dep.datasource = GitTagsDatasource.id;\n  } else if (source) {\n    const moduleParts = source.split('//')[0].split('/');\n    if (moduleParts[0] === '..') {\n      dep.skipReason = 'local';\n    } else if (moduleParts.length >= 3) {\n      const hostnameMatch = hostnameMatchRegex.exec(source);\n      if (hostnameMatch?.groups) {\n        dep.registryUrls = [`https://${hostnameMatch.groups.hostname}`];\n      }\n      dep.depType = 'module';\n      dep.depName = moduleParts.join('/');\n      dep.datasource = TerraformModuleDatasource.id;\n    }\n  } else {\n    logger.debug({ dep }, 'terraform dep has no source');\n    dep.skipReason = 'no-source';\n  }\n}\n"]}
{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/helmsman/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { load } from 'js-yaml';\nimport { logger } from '../../../logger';\nimport { regEx } from '../../../util/regex';\nimport { HelmDatasource } from '../../datasource/helm';\nimport type { ExtractConfig, PackageDependency, PackageFile } from '../types';\nimport type { HelmsmanDocument } from './types';\n\nconst chartRegex = regEx('^(?<registryRef>[^/]*)/(?<packageName>[^/]*)$');\n\nfunction createDep(\n  key: string,\n  doc: HelmsmanDocument\n): PackageDependency | null {\n  const dep: PackageDependency = {\n    depName: key,\n    datasource: HelmDatasource.id,\n  };\n  const anApp = doc.apps[key];\n  if (!anApp) {\n    return null;\n  }\n\n  if (!anApp.version) {\n    dep.skipReason = 'no-version';\n    return dep;\n  }\n  dep.currentValue = anApp.version;\n\n  const regexResult = anApp.chart ? chartRegex.exec(anApp.chart) : null;\n  if (!regexResult?.groups) {\n    dep.skipReason = 'invalid-url';\n    return dep;\n  }\n\n  if (!is.nonEmptyString(regexResult.groups.packageName)) {\n    dep.skipReason = 'invalid-name';\n    return dep;\n  }\n  dep.packageName = regexResult.groups.packageName;\n\n  const registryUrl = doc.helmRepos[regexResult.groups.registryRef];\n  if (!is.nonEmptyString(registryUrl)) {\n    dep.skipReason = 'no-repository';\n    return dep;\n  }\n  dep.registryUrls = [registryUrl];\n\n  return dep;\n}\n\nexport function extractPackageFile(\n  content: string,\n  fileName: string,\n  config: ExtractConfig\n): PackageFile | null {\n  try {\n    // TODO: fix me (#9610)\n    const doc = load(content, {\n      json: true,\n    }) as HelmsmanDocument;\n    if (!(doc?.helmRepos && doc.apps)) {\n      logger.debug({ fileName }, 'Missing helmRepos and/or apps keys');\n      return null;\n    }\n\n    const deps = Object.keys(doc.apps)\n      .map((key) => createDep(key, doc))\n      .filter(is.truthy); // filter null values\n\n    if (deps.length === 0) {\n      return null;\n    }\n\n    return { deps };\n  } catch (err) /* istanbul ignore next */ {\n    if (err.stack?.startsWith('YAMLException:')) {\n      logger.debug({ err }, 'YAML exception extracting');\n    } else {\n      logger.warn({ err }, 'Error extracting');\n    }\n    return null;\n  }\n}\n"]}
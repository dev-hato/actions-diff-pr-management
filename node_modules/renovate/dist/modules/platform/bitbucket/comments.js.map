{"version":3,"file":"comments.js","sourceRoot":"","sources":["../../../../lib/modules/platform/bitbucket/comments.ts"],"names":[],"mappings":"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","sourcesContent":["import { logger } from '../../../logger';\nimport { BitbucketHttp } from '../../../util/http/bitbucket';\nimport type { EnsureCommentConfig, EnsureCommentRemovalConfig } from '../types';\nimport { Config, accumulateValues } from './utils';\n\nconst bitbucketHttp = new BitbucketHttp();\n\ninterface Comment {\n  content: { raw: string };\n  id: number;\n}\n\nexport type CommentsConfig = Pick<Config, 'repository'>;\n\ninterface EnsureBitBucketCommentConfig extends EnsureCommentConfig {\n  config: CommentsConfig;\n}\n\nasync function getComments(\n  config: CommentsConfig,\n  prNo: number\n): Promise<Comment[]> {\n  const comments = await accumulateValues<Comment>(\n    `/2.0/repositories/${config.repository}/pullrequests/${prNo}/comments`\n  );\n\n  logger.debug(`Found ${comments.length} comments`);\n  return comments;\n}\n\nasync function addComment(\n  config: CommentsConfig,\n  prNo: number,\n  raw: string\n): Promise<void> {\n  await bitbucketHttp.postJson(\n    `/2.0/repositories/${config.repository}/pullrequests/${prNo}/comments`,\n    {\n      body: { content: { raw } },\n    }\n  );\n}\n\nasync function editComment(\n  config: CommentsConfig,\n  prNo: number,\n  commentId: number,\n  raw: string\n): Promise<void> {\n  await bitbucketHttp.putJson(\n    `/2.0/repositories/${config.repository}/pullrequests/${prNo}/comments/${commentId}`,\n    {\n      body: { content: { raw } },\n    }\n  );\n}\n\nasync function deleteComment(\n  config: CommentsConfig,\n  prNo: number,\n  commentId: number\n): Promise<void> {\n  await bitbucketHttp.deleteJson(\n    `/2.0/repositories/${config.repository}/pullrequests/${prNo}/comments/${commentId}`\n  );\n}\n\nexport async function ensureComment({\n  config,\n  number: prNo,\n  topic,\n  content,\n}: EnsureBitBucketCommentConfig): Promise<boolean> {\n  try {\n    const comments = await getComments(config, prNo);\n    let body: string;\n    let commentId: number | undefined;\n    let commentNeedsUpdating: boolean | undefined;\n    if (topic) {\n      logger.debug(`Ensuring comment \"${topic}\" in #${prNo}`);\n      body = `### ${topic}\\n\\n${content}`;\n      comments.forEach((comment) => {\n        if (comment.content.raw.startsWith(`### ${topic}\\n\\n`)) {\n          commentId = comment.id;\n          commentNeedsUpdating = comment.content.raw !== body;\n        }\n      });\n    } else {\n      logger.debug(`Ensuring content-only comment in #${prNo}`);\n      body = `${content}`;\n      comments.forEach((comment) => {\n        if (comment.content.raw === body) {\n          commentId = comment.id;\n          commentNeedsUpdating = false;\n        }\n      });\n    }\n    if (!commentId) {\n      await addComment(config, prNo, body);\n      logger.info(\n        { repository: config.repository, prNo, topic },\n        'Comment added'\n      );\n    } else if (commentNeedsUpdating) {\n      await editComment(config, prNo, commentId, body);\n      logger.debug({ repository: config.repository, prNo }, 'Comment updated');\n    } else {\n      logger.debug('Comment is already update-to-date');\n    }\n    return true;\n  } catch (err) /* istanbul ignore next */ {\n    logger.warn({ err }, 'Error ensuring comment');\n    return false;\n  }\n}\n\nexport async function ensureCommentRemoval(\n  config: CommentsConfig,\n  deleteConfig: EnsureCommentRemovalConfig\n): Promise<void> {\n  try {\n    const { number: prNo } = deleteConfig;\n    const key =\n      deleteConfig.type === 'by-topic'\n        ? deleteConfig.topic\n        : deleteConfig.content;\n    logger.debug(`Ensuring comment \"${key}\" in #${prNo} is removed`);\n    const comments = await getComments(config, prNo);\n\n    let commentId: number | undefined = undefined;\n\n    if (deleteConfig.type === 'by-topic') {\n      const byTopic = (comment: Comment): boolean =>\n        comment.content.raw.startsWith(`### ${deleteConfig.topic}\\n\\n`);\n      commentId = comments.find(byTopic)?.id;\n    } else if (deleteConfig.type === 'by-content') {\n      const byContent = (comment: Comment): boolean =>\n        comment.content.raw.trim() === deleteConfig.content;\n      commentId = comments.find(byContent)?.id;\n    }\n\n    if (commentId) {\n      await deleteComment(config, prNo, commentId);\n    }\n  } catch (err) /* istanbul ignore next */ {\n    logger.warn({ err }, 'Error ensuring comment removal');\n  }\n}\n"]}
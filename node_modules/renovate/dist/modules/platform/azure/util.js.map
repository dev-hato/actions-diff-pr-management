{"version":3,"file":"util.js","sourceRoot":"","sources":["../../../../lib/modules/platform/azure/util.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  GitPullRequest,\n  GitRepository,\n  GitStatusContext,\n  PullRequestStatus,\n} from 'azure-devops-node-api/interfaces/GitInterfaces.js';\nimport { logger } from '../../../logger';\nimport { HostRule, PrState } from '../../../types';\nimport type { GitOptions } from '../../../types/git';\nimport { addSecretForSanitizing } from '../../../util/sanitize';\nimport { toBase64 } from '../../../util/string';\nimport { getPrBodyStruct } from '../pr-body';\nimport type { AzurePr } from './types';\n\nexport function getNewBranchName(branchName?: string): string | undefined {\n  if (branchName && !branchName.startsWith('refs/heads/')) {\n    return `refs/heads/${branchName}`;\n  }\n  return branchName;\n}\n\nexport function getGitStatusContextCombinedName(\n  context: GitStatusContext | null | undefined\n): string | undefined {\n  if (!context) {\n    return undefined;\n  }\n  const combinedName = `${context.genre ? `${context.genre}/` : ''}${\n    // TODO: types (#7154)\n    context.name!\n  }`;\n  logger.trace(`Got combined context name of ${combinedName}`);\n  return combinedName;\n}\n\nexport function getGitStatusContextFromCombinedName(\n  context: string | undefined | null\n): GitStatusContext | undefined {\n  if (!context) {\n    return undefined;\n  }\n  let name = context;\n  let genre: string | undefined;\n  const lastSlash = context.lastIndexOf('/');\n  if (lastSlash > 0) {\n    name = context.substring(lastSlash + 1);\n    genre = context.substring(0, lastSlash);\n  }\n  return {\n    genre,\n    name,\n  };\n}\n\nexport function getBranchNameWithoutRefsheadsPrefix(\n  branchPath: string | undefined\n): string | undefined {\n  if (!branchPath) {\n    logger.error(`getBranchNameWithoutRefsheadsPrefix(undefined)`);\n    return undefined;\n  }\n  if (!branchPath.startsWith('refs/heads/')) {\n    logger.trace(\n      `The refs/heads/ name should have started with 'refs/heads/' but it didn't. (${branchPath})`\n    );\n    return branchPath;\n  }\n  return branchPath.substring(11, branchPath.length);\n}\n\nexport function getBranchNameWithoutRefsPrefix(\n  branchPath?: string\n): string | undefined {\n  if (!branchPath) {\n    logger.error(`getBranchNameWithoutRefsPrefix(undefined)`);\n    return undefined;\n  }\n  if (!branchPath.startsWith('refs/')) {\n    logger.trace(\n      `The ref name should have started with 'refs/' but it didn't. (${branchPath})`\n    );\n    return branchPath;\n  }\n  return branchPath.substring(5, branchPath.length);\n}\n\nconst stateMap = {\n  [PullRequestStatus.Abandoned]: PrState.Closed,\n  [PullRequestStatus.Completed]: PrState.Merged,\n} as Record<PullRequestStatus, PrState | undefined>;\n\nexport function getRenovatePRFormat(azurePr: GitPullRequest): AzurePr {\n  const number = azurePr.pullRequestId;\n  // TODO: types (#7154)\n  const displayNumber = `Pull Request #${number!}`;\n\n  const sourceBranch = getBranchNameWithoutRefsheadsPrefix(\n    azurePr.sourceRefName\n  );\n  const targetBranch = getBranchNameWithoutRefsheadsPrefix(\n    azurePr.targetRefName\n  );\n  const bodyStruct = getPrBodyStruct(azurePr.description);\n\n  const createdAt = azurePr.creationDate?.toISOString();\n\n  // TODO #7154\n  const state = stateMap[azurePr.status!] ?? PrState.Open;\n\n  const sourceRefName = azurePr.sourceRefName;\n\n  return {\n    ...azurePr,\n    sourceBranch,\n    state,\n    number,\n    displayNumber,\n    bodyStruct,\n    sourceRefName,\n    targetBranch,\n    createdAt,\n  } as AzurePr;\n}\n\nexport function getStorageExtraCloneOpts(config: HostRule): GitOptions {\n  let authType: string;\n  let authValue: string;\n  if (!config.token && config.username && config.password) {\n    authType = 'basic';\n    authValue = toBase64(`${config.username}:${config.password}`);\n  } else if (config.token?.length === 52) {\n    authType = 'basic';\n    authValue = toBase64(`:${config.token}`);\n  } else {\n    authType = 'bearer';\n    authValue = config.token!;\n  }\n  addSecretForSanitizing(authValue, 'global');\n  return {\n    '-c': `http.extraheader=AUTHORIZATION: ${authType} ${authValue}`,\n  };\n}\n\nexport function max4000Chars(str: string): string {\n  if (str && str.length >= 4000) {\n    return str.substring(0, 3999);\n  }\n  return str;\n}\n\nexport function getProjectAndRepo(str: string): {\n  project: string;\n  repo: string;\n} {\n  logger.trace(`getProjectAndRepo(${str})`);\n  const strSplit = str.split(`/`);\n  if (strSplit.length === 1) {\n    return {\n      project: str,\n      repo: str,\n    };\n  }\n  if (strSplit.length === 2) {\n    return {\n      project: strSplit[0],\n      repo: strSplit[1],\n    };\n  }\n  const msg = `${str} can be only structured this way : 'repository' or 'projectName/repository'!`;\n  logger.error(msg);\n  throw new Error(msg);\n}\n\nexport function getRepoByName(\n  name: string,\n  repos: (GitRepository | null | undefined)[] | undefined | null\n): GitRepository | null {\n  logger.trace(`getRepoByName(${name})`);\n\n  let { project, repo } = getProjectAndRepo(name);\n  project = project.toLowerCase();\n  repo = repo.toLowerCase();\n\n  return (\n    repos?.find(\n      (r) =>\n        project === r?.project?.name?.toLowerCase() &&\n        repo === r?.name?.toLowerCase()\n    ) ?? null\n  );\n}\n"]}
{"version":3,"file":"vulnerability.js","sourceRoot":"","sources":["../../../../lib/workers/repository/init/vulnerability.ts"],"names":[],"mappings":"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","sourcesContent":["import type { PackageRule, RenovateConfig } from '../../../config/types';\nimport { NO_VULNERABILITY_ALERTS } from '../../../constants/error-messages';\nimport { logger } from '../../../logger';\nimport { CrateDatasource } from '../../../modules/datasource/crate';\nimport { MavenDatasource } from '../../../modules/datasource/maven';\nimport { NpmDatasource } from '../../../modules/datasource/npm';\nimport { NugetDatasource } from '../../../modules/datasource/nuget';\nimport { PackagistDatasource } from '../../../modules/datasource/packagist';\nimport { PypiDatasource } from '../../../modules/datasource/pypi';\nimport { RubyGemsDatasource } from '../../../modules/datasource/rubygems';\nimport { platform } from '../../../modules/platform';\nimport * as allVersioning from '../../../modules/versioning';\nimport * as composerVersioning from '../../../modules/versioning/composer';\nimport * as mavenVersioning from '../../../modules/versioning/maven';\nimport * as npmVersioning from '../../../modules/versioning/npm';\nimport * as pep440Versioning from '../../../modules/versioning/pep440';\nimport * as rubyVersioning from '../../../modules/versioning/ruby';\nimport * as semverVersioning from '../../../modules/versioning/semver';\nimport type { SecurityAdvisory } from '../../../types';\nimport { sanitizeMarkdown } from '../../../util/markdown';\nimport { regEx } from '../../../util/regex';\n\ntype Datasource = string;\ntype DependencyName = string;\ntype FileName = string;\ntype VulnerableRequirements = string;\n\ntype CombinedAlert = Record<\n  FileName,\n  Record<\n    Datasource,\n    Record<\n      DependencyName,\n      Record<\n        VulnerableRequirements,\n        {\n          advisories: SecurityAdvisory[];\n          fileType?: string;\n          firstPatchedVersion?: string;\n        }\n      >\n    >\n  >\n>;\n\n// TODO can return `null` and `undefined` (#7154)\nexport async function detectVulnerabilityAlerts(\n  input: RenovateConfig\n): Promise<RenovateConfig> {\n  if (!input?.vulnerabilityAlerts) {\n    return input;\n  }\n  if (input.vulnerabilityAlerts.enabled === false) {\n    logger.debug('Vulnerability alerts are disabled');\n    return input;\n  }\n  const alerts = await platform.getVulnerabilityAlerts();\n  if (!alerts.length) {\n    logger.debug('No vulnerability alerts found');\n    if (input.vulnerabilityAlertsOnly) {\n      throw new Error(NO_VULNERABILITY_ALERTS);\n    }\n    return input;\n  }\n  const config = { ...input };\n  const versionings: Record<string, string> = {\n    packagist: composerVersioning.id,\n    maven: mavenVersioning.id,\n    npm: npmVersioning.id,\n    nuget: semverVersioning.id,\n    pypi: pep440Versioning.id,\n    rubygems: rubyVersioning.id,\n  };\n  const combinedAlerts: CombinedAlert = {};\n  for (const alert of alerts) {\n    if (\n      alert.securityVulnerability?.package?.name === 'yargs-parser' &&\n      (alert.vulnerableRequirements === '= 5.0.0-security.0' ||\n        alert.vulnerableRequirements === '= 5.0.1')\n    ) {\n      continue;\n    }\n    try {\n      if (alert.dismissReason) {\n        continue;\n      }\n      if (!alert.securityVulnerability.firstPatchedVersion) {\n        logger.debug(\n          { alert },\n          'Vulnerability alert has no firstPatchedVersion - skipping'\n        );\n        continue;\n      }\n      const datasourceMapping: Record<string, string> = {\n        COMPOSER: PackagistDatasource.id,\n        MAVEN: MavenDatasource.id,\n        NPM: NpmDatasource.id,\n        NUGET: NugetDatasource.id,\n        PIP: PypiDatasource.id,\n        RUBYGEMS: RubyGemsDatasource.id,\n        RUST: CrateDatasource.id,\n      };\n      const datasource =\n        datasourceMapping[alert.securityVulnerability.package.ecosystem];\n      const depName = alert.securityVulnerability.package.name;\n      const fileName = alert.vulnerableManifestPath;\n      const fileType = alert.vulnerableManifestFilename;\n      const firstPatchedVersion =\n        alert.securityVulnerability.firstPatchedVersion.identifier;\n      const advisory = alert.securityAdvisory;\n      // TODO #7154\n      let vulnerableRequirements = alert.vulnerableRequirements!;\n      // istanbul ignore if\n      if (!vulnerableRequirements.length) {\n        if (datasource === MavenDatasource.id) {\n          vulnerableRequirements = `(,${firstPatchedVersion})`;\n        } else {\n          vulnerableRequirements = `< ${firstPatchedVersion}`;\n        }\n      }\n      if (datasource === PypiDatasource.id) {\n        vulnerableRequirements = vulnerableRequirements.replace(\n          regEx(/^= /),\n          '== '\n        );\n      }\n      combinedAlerts[fileName] ||= {};\n      combinedAlerts[fileName][datasource] ||= {};\n      combinedAlerts[fileName][datasource][depName] ||= {};\n      combinedAlerts[fileName][datasource][depName][vulnerableRequirements] ||=\n        {\n          advisories: [],\n        };\n      const alertDetails =\n        combinedAlerts[fileName][datasource][depName][vulnerableRequirements];\n      alertDetails.advisories.push(advisory);\n      const version = allVersioning.get(versionings[datasource]);\n      if (version.isVersion(firstPatchedVersion)) {\n        if (\n          !alertDetails.firstPatchedVersion ||\n          version.isGreaterThan(\n            firstPatchedVersion,\n            alertDetails.firstPatchedVersion\n          )\n        ) {\n          alertDetails.firstPatchedVersion = firstPatchedVersion;\n        }\n      } else {\n        logger.debug('Invalid firstPatchedVersion: ' + firstPatchedVersion);\n      }\n      alertDetails.fileType = fileType;\n    } catch (err) {\n      logger.warn({ err }, 'Error parsing vulnerability alert');\n    }\n  }\n  const alertPackageRules: PackageRule[] = [];\n  config.remediations = {} as never;\n  for (const [fileName, files] of Object.entries(combinedAlerts)) {\n    for (const [datasource, dependencies] of Object.entries(files)) {\n      for (const [depName, currentValues] of Object.entries(dependencies)) {\n        for (const [matchCurrentVersion, val] of Object.entries(\n          currentValues\n        )) {\n          let prBodyNotes: string[] = [];\n          try {\n            prBodyNotes = ['### GitHub Vulnerability Alerts'].concat(\n              val.advisories.map((advisory) => {\n                const identifiers = advisory.identifiers!;\n                const description = advisory.description!;\n                let content = '#### ';\n                let heading: string;\n                if (identifiers.some((id) => id.type === 'CVE')) {\n                  heading = identifiers\n                    .filter((id) => id.type === 'CVE')\n                    .map((id) => id.value)\n                    .join(' / ');\n                } else {\n                  heading = identifiers.map((id) => id.value).join(' / ');\n                }\n                if (advisory.references.length) {\n                  heading = `[${heading}](${advisory.references[0].url})`;\n                }\n                content += heading;\n                content += '\\n\\n';\n\n                content += sanitizeMarkdown(description);\n                return content;\n              })\n            );\n          } catch (err) /* istanbul ignore next */ {\n            logger.warn({ err }, 'Error generating vulnerability PR notes');\n          }\n          // TODO: types (#7154)\n          const allowedVersions =\n            datasource === PypiDatasource.id\n              ? `==${val.firstPatchedVersion!}`\n              : val.firstPatchedVersion;\n          let matchRule: PackageRule = {\n            matchDatasources: [datasource],\n            matchPackageNames: [depName],\n            matchCurrentVersion,\n            matchFiles: [fileName],\n          };\n          const supportedRemediationFileTypes = ['package-lock.json'];\n          if (\n            config.transitiveRemediation &&\n            supportedRemediationFileTypes.includes(val.fileType!)\n          ) {\n            const remediations = config.remediations as Record<\n              string,\n              unknown[]\n            >;\n            remediations[fileName] ??= [];\n            const currentVersion = matchCurrentVersion.replace('=', '').trim();\n            const newVersion = allowedVersions;\n            const remediation = {\n              datasource,\n              depName,\n              currentVersion,\n              newVersion,\n              prBodyNotes,\n            };\n            remediations[fileName].push(remediation);\n          } else {\n            // Remediate only direct dependencies\n            matchRule = {\n              ...matchRule,\n              allowedVersions,\n              prBodyNotes,\n              isVulnerabilityAlert: true,\n              force: {\n                ...config.vulnerabilityAlerts,\n              },\n            };\n            // istanbul ignore if\n            if (\n              config.transitiveRemediation &&\n              matchRule.matchFiles?.[0] === 'package.json'\n            ) {\n              matchRule.force!.rangeStrategy = 'replace';\n            }\n          }\n          alertPackageRules.push(matchRule);\n        }\n      }\n    }\n  }\n  logger.debug({ alertPackageRules }, 'alert package rules');\n  config.packageRules = (config.packageRules ?? []).concat(alertPackageRules);\n  return config;\n}\n"]}
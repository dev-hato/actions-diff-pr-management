{"version":3,"file":"automerge.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/update/branch/automerge.ts"],"names":[],"mappings":"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","sourcesContent":["// TODO #7154\nimport { GlobalConfig } from '../../../../config/global';\nimport type { RenovateConfig } from '../../../../config/types';\nimport { logger } from '../../../../logger';\nimport { platform } from '../../../../modules/platform';\nimport { BranchStatus } from '../../../../types';\nimport { mergeBranch } from '../../../../util/git';\nimport { isScheduledNow } from './schedule';\nimport { resolveBranchStatus } from './status-checks';\n\nexport type AutomergeResult =\n  | 'automerged'\n  | 'automerge aborted - PR exists'\n  | 'branch status error'\n  | 'failed'\n  | 'no automerge'\n  | 'stale'\n  | 'off schedule'\n  | 'not ready';\n\nexport async function tryBranchAutomerge(\n  config: RenovateConfig\n): Promise<AutomergeResult> {\n  logger.debug('Checking if we can automerge branch');\n  if (!(config.automerge && config.automergeType === 'branch')) {\n    return 'no automerge';\n  }\n  if (!isScheduledNow(config, 'automergeSchedule')) {\n    return 'off schedule';\n  }\n  const existingPr = await platform.getBranchPr(config.branchName!);\n  if (existingPr) {\n    return 'automerge aborted - PR exists';\n  }\n  const branchStatus = await resolveBranchStatus(\n    config.branchName!,\n    config.ignoreTests\n  );\n  if (branchStatus === BranchStatus.green) {\n    logger.debug(`Automerging branch`);\n    try {\n      if (GlobalConfig.get('dryRun')) {\n        // TODO: types (#7154)\n        logger.info(`DRY-RUN: Would automerge branch ${config.branchName!}`);\n      } else {\n        await mergeBranch(config.branchName!);\n      }\n      logger.info({ branch: config.branchName }, 'Branch automerged');\n      return 'automerged'; // Branch no longer exists\n    } catch (err) /* istanbul ignore next */ {\n      if (err.message === 'not ready') {\n        logger.debug('Branch is not ready for automerge');\n        return 'not ready';\n      }\n      if (\n        err.message.includes('refusing to merge unrelated histories') ||\n        err.message.includes('Not possible to fast-forward') ||\n        err.message.includes(\n          'Updates were rejected because the tip of your current branch is behind'\n        )\n      ) {\n        logger.debug({ err }, 'Branch automerge error');\n        logger.info('Branch is not up to date - cannot automerge');\n        return 'stale';\n      }\n      if (err.message.includes('Protected branch')) {\n        if (err.message.includes('status check')) {\n          logger.debug(\n            { err },\n            'Branch is not ready for automerge: required status checks are remaining'\n          );\n          return 'not ready';\n        }\n        if (err.stack?.includes('reviewers')) {\n          logger.info(\n            { err },\n            'Branch automerge is not possible due to branch protection (required reviewers)'\n          );\n          return 'failed';\n        }\n        logger.info(\n          { err },\n          'Branch automerge is not possible due to branch protection'\n        );\n        return 'failed';\n      }\n      logger.warn({ err }, 'Unknown error when attempting branch automerge');\n      return 'failed';\n    }\n  } else if (branchStatus === BranchStatus.red) {\n    return 'branch status error';\n  } else {\n    logger.debug(`Branch status is \"${branchStatus}\" - skipping automerge`);\n  }\n  return 'no automerge';\n}\n"]}
{"version":3,"file":"automerge.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/update/pr/automerge.ts"],"names":[],"mappings":"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","sourcesContent":["// TODO #7154\nimport { GlobalConfig } from '../../../../config/global';\nimport { logger } from '../../../../logger';\nimport { Pr, platform } from '../../../../modules/platform';\nimport {\n  ensureComment,\n  ensureCommentRemoval,\n} from '../../../../modules/platform/comment';\nimport { BranchStatus } from '../../../../types';\nimport {\n  deleteBranch,\n  isBranchConflicted,\n  isBranchModified,\n} from '../../../../util/git';\nimport type { BranchConfig } from '../../../types';\nimport { isScheduledNow } from '../branch/schedule';\nimport { resolveBranchStatus } from '../branch/status-checks';\n\n// eslint-disable-next-line typescript-enum/no-enum\nexport enum PrAutomergeBlockReason {\n  BranchModified = 'BranchModified',\n  BranchNotGreen = 'BranchNotGreen',\n  Conflicted = 'Conflicted',\n  DryRun = 'DryRun',\n  PlatformNotReady = 'PlatformNotReady',\n  PlatformRejection = 'PlatformRejection',\n  OffSchedule = 'off schedule',\n}\n\nexport interface AutomergePrResult {\n  automerged: boolean;\n  branchRemoved?: boolean;\n  prAutomergeBlockReason?: PrAutomergeBlockReason;\n}\n\nexport async function checkAutoMerge(\n  pr: Pr,\n  config: BranchConfig\n): Promise<AutomergePrResult> {\n  logger.trace({ config }, 'checkAutoMerge');\n  const {\n    branchName,\n    automergeType,\n    automergeStrategy,\n    pruneBranchAfterAutomerge,\n    automergeComment,\n    ignoreTests,\n    rebaseRequested,\n  } = config;\n  // Return if PR not ready for automerge\n  if (!isScheduledNow(config, 'automergeSchedule')) {\n    logger.debug(`PR automerge is off schedule`);\n    return {\n      automerged: false,\n      prAutomergeBlockReason: PrAutomergeBlockReason.OffSchedule,\n    };\n  }\n  const isConflicted =\n    config.isConflicted ??\n    (await isBranchConflicted(config.baseBranch!, config.branchName));\n  if (isConflicted) {\n    logger.debug('PR is conflicted');\n    return {\n      automerged: false,\n      prAutomergeBlockReason: PrAutomergeBlockReason.Conflicted,\n    };\n  }\n  if (!ignoreTests && pr.cannotMergeReason) {\n    logger.debug(\n      `Platform reported that PR is not ready for merge. Reason: [${pr.cannotMergeReason}]`\n    );\n    return {\n      automerged: false,\n      prAutomergeBlockReason: PrAutomergeBlockReason.PlatformNotReady,\n    };\n  }\n  const branchStatus = await resolveBranchStatus(\n    config.branchName,\n    config.ignoreTests\n  );\n  if (branchStatus !== BranchStatus.green) {\n    logger.debug(\n      `PR is not ready for merge (branch status is ${branchStatus})`\n    );\n    return {\n      automerged: false,\n      prAutomergeBlockReason: PrAutomergeBlockReason.BranchNotGreen,\n    };\n  }\n  // Check if it's been touched\n  if (await isBranchModified(branchName)) {\n    logger.debug('PR is ready for automerge but has been modified');\n    return {\n      automerged: false,\n      prAutomergeBlockReason: PrAutomergeBlockReason.BranchModified,\n    };\n  }\n  if (automergeType === 'pr-comment') {\n    // TODO: types (#7154)\n    logger.debug(`Applying automerge comment: ${automergeComment!}`);\n    // istanbul ignore if\n    if (GlobalConfig.get('dryRun')) {\n      logger.info(\n        `DRY-RUN: Would add PR automerge comment to PR #${pr.number}`\n      );\n      return {\n        automerged: false,\n        prAutomergeBlockReason: PrAutomergeBlockReason.DryRun,\n      };\n    }\n    if (rebaseRequested) {\n      await ensureCommentRemoval({\n        type: 'by-content',\n        number: pr.number,\n        content: automergeComment!,\n      });\n    }\n    await ensureComment({\n      number: pr.number,\n      topic: null,\n      content: automergeComment!,\n    });\n    return { automerged: true, branchRemoved: false };\n  }\n  // Let's merge this\n  // istanbul ignore if\n  if (GlobalConfig.get('dryRun')) {\n    // TODO: types (#7154)\n    logger.info(\n      `DRY-RUN: Would merge PR #${\n        pr.number\n      } with strategy \"${automergeStrategy!}\"`\n    );\n    return {\n      automerged: false,\n      prAutomergeBlockReason: PrAutomergeBlockReason.DryRun,\n    };\n  }\n  // TODO: types (#7154)\n  logger.debug(`Automerging #${pr.number} with strategy ${automergeStrategy!}`);\n  const res = await platform.mergePr({\n    branchName,\n    id: pr.number,\n    strategy: automergeStrategy,\n  });\n  if (res) {\n    logger.info({ pr: pr.number, prTitle: pr.title }, 'PR automerged');\n    if (!pruneBranchAfterAutomerge) {\n      logger.info('Skipping pruning of merged branch');\n      return { automerged: true, branchRemoved: false };\n    }\n    let branchRemoved = false;\n    try {\n      await deleteBranch(branchName);\n      branchRemoved = true;\n    } catch (err) /* istanbul ignore next */ {\n      logger.warn({ branchName, err }, 'Branch auto-remove failed');\n    }\n    return { automerged: true, branchRemoved };\n  }\n  return {\n    automerged: false,\n    prAutomergeBlockReason: PrAutomergeBlockReason.PlatformRejection,\n  };\n}\n"]}
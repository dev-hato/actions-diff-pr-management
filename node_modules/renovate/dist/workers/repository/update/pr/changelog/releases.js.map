{"version":3,"file":"releases.js","sourceRoot":"","sources":["../../../../../../lib/workers/repository/update/pr/changelog/releases.ts"],"names":[],"mappings":";;;AAAA,aAAa;AACb,kDAA+C;AAC/C,kEAI2C;AAC3C,kEAAuE;AAGvE,SAAS,UAAU,CAAC,OAAsB,EAAE,EAAU,EAAE,EAAU;IAChE,OAAO,CACL,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,KAAK,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC;QAC7C,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,KAAK,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC;QAC7C,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,KAAK,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,CAC9C,CAAC;AACJ,CAAC;AAED,SAAS,eAAe,CACtB,OAAsB,EACtB,EAAU,EACV,EAAU;IAEV,OAAO,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,IAAI,UAAU,CAAC,OAAO,EAAE,EAAE,EAAE,EAAE,CAAC,CAAC;AAC9D,CAAC;AAEM,KAAK,UAAU,kBAAkB,CACtC,MAA2B;IAE3B,MAAM,UAAU,GAAG,MAAM,CAAC,UAAW,CAAC;IACtC,MAAM,cAAc,GAAG,MAAM,CAAC,cAAe,CAAC;IAC9C,MAAM,UAAU,GAAG,MAAM,CAAC,UAAW,CAAC;IACtC,MAAM,OAAO,GAAG,MAAM,CAAC,OAAQ,CAAC;IAChC,MAAM,UAAU,GAAG,MAAM,CAAC,UAAW,CAAC;IACtC,qBAAqB;IACrB,IAAI,CAAC,IAAA,mCAAsB,EAAC,MAAM,CAAC,EAAE;QACnC,OAAO,IAAI,CAAC;KACb;IACD,IAAI;QACF,MAAM,WAAW,GAAG,CAAC,MAAM,IAAA,2BAAc,EAAC,MAAM,CAAC,CAAE,CAAC,QAAQ,CAAC;QAC7D,MAAM,OAAO,GAAG,IAAA,gBAAG,EAAC,UAAU,CAAC,CAAC;QAEhC,MAAM,QAAQ,GAAG,WAAW;aACzB,MAAM,CAAC,CAAC,OAAO,EAAE,EAAE,CAClB,OAAO,CAAC,YAAY,CAAC,OAAO,CAAC,OAAO,EAAE,cAAc,CAAC,CACtD;aACA,MAAM,CACL,CAAC,OAAO,EAAE,EAAE,CACV,OAAO,CAAC,MAAM,CAAC,OAAO,CAAC,OAAO,EAAE,cAAc,CAAC;YAC/C,OAAO,CAAC,aAAa,CAAC,OAAO,CAAC,OAAO,EAAE,cAAc,CAAC,CACzD;aACA,MAAM,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,OAAO,CAAC,aAAa,CAAC,OAAO,CAAC,OAAO,EAAE,UAAU,CAAC,CAAC;aACxE,MAAM,CACL,CAAC,OAAO,EAAE,EAAE,CACV,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC;YACjC,eAAe,CAAC,OAAO,EAAE,cAAc,EAAE,OAAO,CAAC,OAAO,CAAC;YACzD,eAAe,CAAC,OAAO,EAAE,UAAU,EAAE,OAAO,CAAC,OAAO,CAAC,CACxD,CAAC;QACJ,IAAI,OAAO,CAAC,cAAc,EAAE;YAC1B,KAAK,MAAM,OAAO,IAAI,QAAQ,IAAI,EAAE,EAAE;gBACpC,OAAO,CAAC,OAAO,GAAG,OAAO,CAAC,cAAc,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;aAC3D;SACF;QACD,OAAO,QAAQ,CAAC;KACjB;IAAC,OAAO,GAAG,EAAE,0BAA0B,CAAC;QACvC,eAAM,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,EAAE,wBAAwB,CAAC,CAAC;QAChD,eAAM,CAAC,KAAK,CAAC,EAAE,UAAU,EAAE,OAAO,EAAE,EAAE,wBAAwB,CAAC,CAAC;QAChE,OAAO,IAAI,CAAC;KACb;AACH,CAAC;AA3CD,gDA2CC","sourcesContent":["// TODO #7154\nimport { logger } from '../../../../../logger';\nimport {\n  Release,\n  getPkgReleases,\n  isGetPkgReleasesConfig,\n} from '../../../../../modules/datasource';\nimport { VersioningApi, get } from '../../../../../modules/versioning';\nimport type { BranchUpgradeConfig } from '../../../../types';\n\nfunction matchesMMP(version: VersioningApi, v1: string, v2: string): boolean {\n  return (\n    version.getMajor(v1) === version.getMajor(v2) &&\n    version.getMinor(v1) === version.getMinor(v2) &&\n    version.getPatch(v1) === version.getPatch(v2)\n  );\n}\n\nfunction matchesUnstable(\n  version: VersioningApi,\n  v1: string,\n  v2: string\n): boolean {\n  return !version.isStable(v1) && matchesMMP(version, v1, v2);\n}\n\nexport async function getInRangeReleases(\n  config: BranchUpgradeConfig\n): Promise<Release[] | null> {\n  const versioning = config.versioning!;\n  const currentVersion = config.currentVersion!;\n  const newVersion = config.newVersion!;\n  const depName = config.depName!;\n  const datasource = config.datasource!;\n  // istanbul ignore if\n  if (!isGetPkgReleasesConfig(config)) {\n    return null;\n  }\n  try {\n    const pkgReleases = (await getPkgReleases(config))!.releases;\n    const version = get(versioning);\n\n    const releases = pkgReleases\n      .filter((release) =>\n        version.isCompatible(release.version, currentVersion)\n      )\n      .filter(\n        (release) =>\n          version.equals(release.version, currentVersion) ||\n          version.isGreaterThan(release.version, currentVersion)\n      )\n      .filter((release) => !version.isGreaterThan(release.version, newVersion))\n      .filter(\n        (release) =>\n          version.isStable(release.version) ||\n          matchesUnstable(version, currentVersion, release.version) ||\n          matchesUnstable(version, newVersion, release.version)\n      );\n    if (version.valueToVersion) {\n      for (const release of releases || []) {\n        release.version = version.valueToVersion(release.version);\n      }\n    }\n    return releases;\n  } catch (err) /* istanbul ignore next */ {\n    logger.debug({ err }, 'getInRangeReleases err');\n    logger.debug({ datasource, depName }, 'Error getting releases');\n    return null;\n  }\n}\n"]}
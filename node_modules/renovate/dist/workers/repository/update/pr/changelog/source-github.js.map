{"version":3,"file":"source-github.js","sourceRoot":"","sources":["../../../../../../lib/workers/repository/update/pr/changelog/source-github.ts"],"names":[],"mappings":"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","sourcesContent":["// TODO #7154\nimport URL from 'url';\nimport { GlobalConfig } from '../../../../../config/global';\nimport { PlatformId } from '../../../../../constants';\nimport { logger } from '../../../../../logger';\nimport type { Release } from '../../../../../modules/datasource/types';\nimport * as allVersioning from '../../../../../modules/versioning';\nimport * as memCache from '../../../../../util/cache/memory';\nimport * as packageCache from '../../../../../util/cache/package';\nimport * as hostRules from '../../../../../util/host-rules';\nimport { regEx } from '../../../../../util/regex';\nimport type { BranchUpgradeConfig } from '../../../../types';\nimport { getTags } from './github';\nimport { addReleaseNotes } from './release-notes';\nimport { getInRangeReleases } from './releases';\nimport { ChangeLogError, ChangeLogRelease, ChangeLogResult } from './types';\n\nfunction getCachedTags(\n  endpoint: string,\n  repository: string\n): Promise<string[]> {\n  const cacheKey = `getTags-${endpoint}-${repository}`;\n  const cachedResult = memCache.get<Promise<string[]>>(cacheKey);\n  // istanbul ignore if\n  if (cachedResult !== undefined) {\n    return cachedResult;\n  }\n  const promisedRes = getTags(endpoint, repository);\n  memCache.set(cacheKey, promisedRes);\n  return promisedRes;\n}\n\nexport async function getChangeLogJSON(\n  config: BranchUpgradeConfig\n): Promise<ChangeLogResult | null> {\n  const versioning = config.versioning!;\n  const currentVersion = config.currentVersion!;\n  const newVersion = config.newVersion!;\n  const sourceUrl = config.sourceUrl!;\n  const sourceDirectory = config.sourceDirectory!;\n  const depName = config.depName!;\n  const manager = config.manager;\n  if (sourceUrl === 'https://github.com/DefinitelyTyped/DefinitelyTyped') {\n    logger.trace('No release notes for @types');\n    return null;\n  }\n  const version = allVersioning.get(versioning);\n  const { protocol, host, pathname } = URL.parse(sourceUrl);\n  // TODO: types (#7154)\n  const baseUrl = `${protocol!}//${host!}/`;\n  const url = sourceUrl.startsWith('https://github.com/')\n    ? 'https://api.github.com/'\n    : sourceUrl;\n  const { token } = hostRules.find({\n    hostType: PlatformId.Github,\n    url,\n  });\n  // istanbul ignore if\n  if (!token) {\n    if (host!.endsWith('.github.com') || host === 'github.com') {\n      if (!GlobalConfig.get().githubTokenWarn) {\n        logger.debug(\n          { manager, depName, sourceUrl },\n          'GitHub token warning has been suppressed. Skipping release notes retrieval'\n        );\n        return null;\n      }\n      logger.warn(\n        { manager, depName, sourceUrl },\n        'No github.com token has been configured. Skipping release notes retrieval'\n      );\n      return { error: ChangeLogError.MissingGithubToken };\n    }\n    logger.debug(\n      { manager, depName, sourceUrl },\n      'Repository URL does not match any known github hosts - skipping changelog retrieval'\n    );\n    return null;\n  }\n  const apiBaseUrl = sourceUrl.startsWith('https://github.com/')\n    ? 'https://api.github.com/'\n    : baseUrl + 'api/v3/';\n  const repository = pathname!\n    .slice(1)\n    .replace(regEx(/\\/$/), '')\n    .replace(regEx(/\\.git$/), '');\n  if (repository.split('/').length !== 2) {\n    logger.debug({ sourceUrl }, 'Invalid github URL found');\n    return null;\n  }\n  const releases = config.releases ?? (await getInRangeReleases(config));\n  if (!releases?.length) {\n    logger.debug('No releases');\n    return null;\n  }\n  // This extra filter/sort should not be necessary, but better safe than sorry\n  const validReleases = [...releases]\n    .filter((release) => version.isVersion(release.version))\n    .sort((a, b) => version.sortVersions(a.version, b.version));\n\n  if (validReleases.length < 2) {\n    logger.debug(`Not enough valid releases for dep ${depName}`);\n    return null;\n  }\n\n  let tags: string[];\n\n  async function getRef(release: Release): Promise<string | null> {\n    if (!tags) {\n      tags = await getCachedTags(apiBaseUrl, repository);\n    }\n    const tagName = findTagOfRelease(version, depName, release.version, tags);\n    if (tagName) {\n      return tagName;\n    }\n    if (release.gitRef) {\n      return release.gitRef;\n    }\n    return null;\n  }\n\n  const cacheNamespace = 'changelog-github-release';\n  function getCacheKey(prev: string, next: string): string {\n    return `${manager}:${depName}:${prev}:${next}`;\n  }\n\n  const changelogReleases: ChangeLogRelease[] = [];\n  // compare versions\n  const include = (v: string): boolean =>\n    version.isGreaterThan(v, currentVersion) &&\n    !version.isGreaterThan(v, newVersion);\n  for (let i = 1; i < validReleases.length; i += 1) {\n    const prev = validReleases[i - 1];\n    const next = validReleases[i];\n    if (include(next.version)) {\n      let release = await packageCache.get(\n        cacheNamespace,\n        getCacheKey(prev.version, next.version)\n      );\n      // istanbul ignore else\n      if (!release) {\n        release = {\n          version: next.version,\n          gitRef: next.gitRef,\n          date: next.releaseTimestamp,\n          // put empty changes so that existing templates won't break\n          changes: [],\n          compare: {},\n        };\n        const prevHead = await getRef(prev);\n        const nextHead = await getRef(next);\n        if (prevHead && nextHead) {\n          release.compare.url = `${baseUrl}${repository}/compare/${prevHead}...${nextHead}`;\n        }\n        const cacheMinutes = 55;\n        await packageCache.set(\n          cacheNamespace,\n          getCacheKey(prev.version, next.version),\n          release,\n          cacheMinutes\n        );\n      }\n      changelogReleases.unshift(release);\n    }\n  }\n\n  let res: ChangeLogResult = {\n    project: {\n      apiBaseUrl,\n      baseUrl,\n      type: 'github',\n      repository,\n      sourceUrl,\n      sourceDirectory,\n      depName,\n    },\n    versions: changelogReleases,\n  };\n\n  res = await addReleaseNotes(res, config);\n\n  return res;\n}\n\nfunction findTagOfRelease(\n  version: allVersioning.VersioningApi,\n  depName: string,\n  depNewVersion: string,\n  tags: string[]\n): string | undefined {\n  const regex = regEx(`(?:${depName}|release)[@-]`, undefined, false);\n  const excactReleaseRegex = regEx(`${depName}[@-_]v?${depNewVersion}`);\n  const exactTagsList = tags.filter((tag) => {\n    return excactReleaseRegex.test(tag);\n  });\n  let tagName: string | undefined;\n  if (exactTagsList.length) {\n    tagName = exactTagsList\n      .filter((tag) => version.isVersion(tag.replace(regex, '')))\n      .find((tag) => version.equals(tag.replace(regex, ''), depNewVersion));\n  } else {\n    tagName = tags\n      .filter((tag) => version.isVersion(tag.replace(regex, '')))\n      .find((tag) => version.equals(tag.replace(regex, ''), depNewVersion));\n  }\n  return tagName;\n}\n"]}
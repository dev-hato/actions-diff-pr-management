{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/onboarding/pr/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { GlobalConfig } from '../../../../config/global';\nimport type { RenovateConfig } from '../../../../config/types';\nimport { logger } from '../../../../logger';\nimport type { PackageFile } from '../../../../modules/manager/types';\nimport { platform } from '../../../../modules/platform';\nimport { hashBody } from '../../../../modules/platform/pr-body';\nimport { emojify } from '../../../../util/emoji';\nimport {\n  deleteBranch,\n  isBranchConflicted,\n  isBranchModified,\n} from '../../../../util/git';\nimport * as template from '../../../../util/template';\nimport type { BranchConfig } from '../../../types';\nimport {\n  getDepWarningsPR,\n  getErrors,\n  getWarnings,\n} from '../../errors-warnings';\nimport { getPlatformPrOptions } from '../../update/pr';\nimport { prepareLabels } from '../../update/pr/labels';\nimport { addParticipants } from '../../update/pr/participants';\nimport { getBaseBranchDesc } from './base-branch';\nimport { getConfigDesc } from './config-description';\nimport { getPrList } from './pr-list';\n\nexport async function ensureOnboardingPr(\n  config: RenovateConfig,\n  packageFiles: Record<string, PackageFile[]> | null,\n  branches: BranchConfig[]\n): Promise<void> {\n  if (config.repoIsOnboarded) {\n    return;\n  }\n  logger.debug('ensureOnboardingPr()');\n  logger.trace({ config });\n  // TODO #7154\n  const existingPr = await platform.getBranchPr(config.onboardingBranch!);\n  logger.debug('Filling in onboarding PR template');\n  let prTemplate = `Welcome to [Renovate](${\n    config.productLinks!.homepage\n  })! This is an onboarding PR to help you understand and configure settings before regular Pull Requests begin.\\n\\n`;\n  prTemplate +=\n    config.requireConfig === 'required'\n      ? emojify(\n          `:vertical_traffic_light: To activate Renovate, merge this Pull Request. To disable Renovate, simply close this Pull Request unmerged.\\n\\n`\n        )\n      : emojify(\n          `:vertical_traffic_light: Renovate will begin keeping your dependencies up-to-date only once you merge or close this Pull Request.\\n\\n`\n        );\n  // TODO #7154\n  prTemplate += emojify(\n    `\n\n---\n{{PACKAGE FILES}}\n{{CONFIG}}\n{{BASEBRANCH}}\n{{PRLIST}}\n{{WARNINGS}}\n{{ERRORS}}\n\n---\n\n:question: Got questions? Check out Renovate's [Docs](${\n      config.productLinks!.documentation\n    }), particularly the Getting Started section.\nIf you need any further assistance then you can also [request help here](${\n      config.productLinks!.help\n    }).\n`\n  );\n  let prBody = prTemplate;\n  if (packageFiles && Object.entries(packageFiles).length) {\n    let files: string[] = [];\n    for (const [manager, managerFiles] of Object.entries(packageFiles)) {\n      files = files.concat(\n        // TODO: types (#7154)\n        managerFiles.map((file) => ` * \\`${file.packageFile!}\\` (${manager})`)\n      );\n    }\n    prBody =\n      prBody.replace(\n        '{{PACKAGE FILES}}',\n        '### Detected Package Files\\n\\n' + files.join('\\n')\n      ) + '\\n';\n  } else {\n    prBody = prBody.replace('{{PACKAGE FILES}}\\n', '');\n  }\n  let configDesc = '';\n  if (GlobalConfig.get('dryRun')) {\n    // TODO: types (#7154)\n    logger.info(`DRY-RUN: Would check branch ${config.onboardingBranch!}`);\n  } else if (await isBranchModified(config.onboardingBranch!)) {\n    configDesc = emojify(\n      `### Configuration\\n\\n:abcd: Renovate has detected a custom config for this PR. Feel free to ask for [help](${\n        config.productLinks!.help\n      }) if you have any doubts and would like it reviewed.\\n\\n`\n    );\n    const isConflicted = await isBranchConflicted(\n      config.baseBranch!,\n      config.onboardingBranch!\n    );\n    if (isConflicted) {\n      configDesc += emojify(\n        `:warning: This PR has a merge conflict, however Renovate is unable to automatically fix that due to edits in this branch. Please resolve the merge conflict manually.\\n\\n`\n      );\n    } else {\n      configDesc += `Important: Now that this branch is edited, Renovate can't rebase it from the base branch any more. If you make changes to the base branch that could impact this onboarding PR, please merge them manually.\\n\\n`;\n    }\n  } else {\n    configDesc = getConfigDesc(config, packageFiles!);\n  }\n  prBody = prBody.replace('{{CONFIG}}\\n', configDesc);\n  prBody = prBody.replace(\n    '{{WARNINGS}}\\n',\n    getWarnings(config) + getDepWarningsPR(packageFiles!)\n  );\n  prBody = prBody.replace('{{ERRORS}}\\n', getErrors(config));\n  prBody = prBody.replace('{{BASEBRANCH}}\\n', getBaseBranchDesc(config));\n  prBody = prBody.replace('{{PRLIST}}\\n', getPrList(config, branches));\n  if (is.string(config.prHeader)) {\n    prBody = `${template.compile(config.prHeader, config)}\\n\\n${prBody}`;\n  }\n  if (is.string(config.prFooter)) {\n    prBody = `${prBody}\\n---\\n\\n${template.compile(config.prFooter, config)}\\n`;\n  }\n  logger.trace('prBody:\\n' + prBody);\n\n  prBody = platform.massageMarkdown(prBody);\n\n  if (existingPr) {\n    logger.debug('Found open onboarding PR');\n    // Check if existing PR needs updating\n    const prBodyHash = hashBody(prBody);\n    if (existingPr.bodyStruct?.hash === prBodyHash) {\n      // TODO: types (#7154)\n      logger.debug(`${existingPr.displayNumber!} does not need updating`);\n      return;\n    }\n    // PR must need updating\n    if (GlobalConfig.get('dryRun')) {\n      logger.info('DRY-RUN: Would update onboarding PR');\n    } else {\n      await platform.updatePr({\n        number: existingPr.number,\n        prTitle: existingPr.title,\n        prBody,\n      });\n      logger.info({ pr: existingPr.number }, 'Onboarding PR updated');\n    }\n    return;\n  }\n  logger.debug('Creating onboarding PR');\n  const labels: string[] = prepareLabels(config);\n  try {\n    if (GlobalConfig.get('dryRun')) {\n      logger.info('DRY-RUN: Would create onboarding PR');\n    } else {\n      // TODO #7154\n      const pr = await platform.createPr({\n        sourceBranch: config.onboardingBranch!,\n        targetBranch: config.defaultBranch!,\n        prTitle: config.onboardingPrTitle!,\n        prBody,\n        labels,\n        platformOptions: getPlatformPrOptions({ ...config, automerge: false }),\n      });\n      logger.info({ pr: pr!.displayNumber }, 'Onboarding PR created');\n      await addParticipants(config, pr!);\n    }\n  } catch (err) {\n    if (\n      err.response?.statusCode === 422 &&\n      err.response?.body?.errors?.[0]?.message?.startsWith(\n        'A pull request already exists'\n      )\n    ) {\n      logger.warn(\n        'Onboarding PR already exists but cannot find it. It was probably created by a different user.'\n      );\n      await deleteBranch(config.onboardingBranch!);\n      return;\n    }\n    throw err;\n  }\n}\n"]}
{"version":3,"file":"limits.js","sourceRoot":"","sources":["../../../../lib/workers/repository/process/limits.ts"],"names":[],"mappings":"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","sourcesContent":["// TODO #7154\nimport { DateTime } from 'luxon';\nimport type { RenovateConfig } from '../../../config/types';\nimport { logger } from '../../../logger';\nimport { Pr, platform } from '../../../modules/platform';\nimport { PrState } from '../../../types';\nimport { ExternalHostError } from '../../../types/errors/external-host-error';\nimport { branchExists } from '../../../util/git';\nimport type { BranchConfig } from '../../types';\n\nexport async function getPrHourlyRemaining(\n  config: RenovateConfig\n): Promise<number> {\n  if (config.prHourlyLimit) {\n    try {\n      logger.debug('Calculating hourly PRs remaining');\n      const prList = await platform.getPrList();\n      const currentHourStart = DateTime.local().startOf('hour');\n      logger.debug(`currentHourStart=${String(currentHourStart)}`);\n      const soFarThisHour = prList.filter(\n        (pr) =>\n          pr.sourceBranch !== config.onboardingBranch &&\n          pr.sourceBranch.startsWith(config.branchPrefix!) &&\n          DateTime.fromISO(pr.createdAt!) > currentHourStart\n      );\n      const prsRemaining = Math.max(\n        0,\n        config.prHourlyLimit - soFarThisHour.length\n      );\n      logger.debug(`PR hourly limit remaining: ${prsRemaining}`);\n      return prsRemaining;\n    } catch (err) {\n      // istanbul ignore if\n      if (err instanceof ExternalHostError) {\n        throw err;\n      }\n      logger.error({ err }, 'Error checking PRs created per hour');\n      return config.prHourlyLimit;\n    }\n  }\n  return 99;\n}\n\nexport async function getConcurrentPrsRemaining(\n  config: RenovateConfig,\n  branches: BranchConfig[]\n): Promise<number> {\n  if (config.prConcurrentLimit) {\n    logger.debug(`Calculating prConcurrentLimit (${config.prConcurrentLimit})`);\n    try {\n      const openPrs: Pr[] = [];\n      for (const { branchName } of branches) {\n        try {\n          const pr = await platform.getBranchPr(branchName);\n          if (\n            pr &&\n            pr.sourceBranch !== config.onboardingBranch &&\n            pr.state === PrState.Open\n          ) {\n            openPrs.push(pr);\n          }\n        } catch (err) {\n          // no-op\n        }\n      }\n      logger.debug(`${openPrs.length} PRs are currently open`);\n      const concurrentRemaining = Math.max(\n        0,\n        config.prConcurrentLimit - openPrs.length\n      );\n      logger.debug(`PR concurrent limit remaining: ${concurrentRemaining}`);\n      return concurrentRemaining;\n    } catch (err) /* istanbul ignore next */ {\n      logger.error({ err }, 'Error checking concurrent PRs');\n      return config.prConcurrentLimit;\n    }\n  }\n  return 99;\n}\n\nexport async function getPrsRemaining(\n  config: RenovateConfig,\n  branches: BranchConfig[]\n): Promise<number> {\n  const hourlyRemaining = await getPrHourlyRemaining(config);\n  const concurrentRemaining = await getConcurrentPrsRemaining(config, branches);\n  return Math.min(hourlyRemaining, concurrentRemaining);\n}\n\nexport function getConcurrentBranchesRemaining(\n  config: RenovateConfig,\n  branches: BranchConfig[]\n): number {\n  const { branchConcurrentLimit, prConcurrentLimit } = config;\n  const limit =\n    typeof branchConcurrentLimit === 'number'\n      ? branchConcurrentLimit\n      : prConcurrentLimit;\n  if (typeof limit === 'number' && limit) {\n    logger.debug(`Calculating branchConcurrentLimit (${limit})`);\n    try {\n      const existingBranches: string[] = [];\n      for (const branch of branches) {\n        if (branchExists(branch.branchName)) {\n          existingBranches.push(branch.branchName);\n        }\n      }\n\n      const existingCount = existingBranches.length;\n      logger.debug(\n        `${existingCount} already existing branches found: ${existingBranches.join()}`\n      );\n\n      const concurrentRemaining = Math.max(0, limit - existingCount);\n      logger.debug(`Branch concurrent limit remaining: ${concurrentRemaining}`);\n\n      return concurrentRemaining;\n    } catch (err) {\n      // TODO: #7154 should never throw\n      logger.error({ err }, 'Error checking concurrent branches');\n      return limit;\n    }\n  }\n  return 99;\n}\n\nexport async function getBranchesRemaining(\n  config: RenovateConfig,\n  branches: BranchConfig[]\n): Promise<number> {\n  const hourlyRemaining = await getPrHourlyRemaining(config);\n  const concurrentRemaining = getConcurrentBranchesRemaining(config, branches);\n  return Math.min(hourlyRemaining, concurrentRemaining);\n}\n"]}
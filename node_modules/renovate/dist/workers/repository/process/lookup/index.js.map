{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/process/lookup/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { mergeChildConfig } from '../../../../config';\nimport type { ValidationMessage } from '../../../../config/types';\nimport { CONFIG_VALIDATION } from '../../../../constants/error-messages';\nimport { logger } from '../../../../logger';\nimport {\n  Release,\n  getDatasourceList,\n  getDefaultVersioning,\n  getDigest,\n  getPkgReleases,\n  isGetPkgReleasesConfig,\n  supportsDigests,\n} from '../../../../modules/datasource';\nimport { getRangeStrategy } from '../../../../modules/manager';\nimport * as allVersioning from '../../../../modules/versioning';\nimport { ExternalHostError } from '../../../../types/errors/external-host-error';\nimport { clone } from '../../../../util/clone';\nimport { applyPackageRules } from '../../../../util/package-rules';\nimport { regEx } from '../../../../util/regex';\nimport { getBucket } from './bucket';\nimport { mergeConfigConstraints } from './common';\nimport { getCurrentVersion } from './current';\nimport { filterVersions } from './filter';\nimport { filterInternalChecks } from './filter-checks';\nimport { generateUpdate } from './generate';\nimport { getRollbackUpdate } from './rollback';\nimport type { LookupUpdateConfig, UpdateResult } from './types';\n\nexport async function lookupUpdates(\n  inconfig: LookupUpdateConfig\n): Promise<UpdateResult> {\n  let config: LookupUpdateConfig = { ...inconfig };\n  const {\n    currentDigest,\n    currentValue,\n    datasource,\n    depName,\n    digestOneAndOnly,\n    followTag,\n    lockedVersion,\n    packageFile,\n    pinDigests,\n    rollbackPrs,\n    isVulnerabilityAlert,\n    updatePinnedDependencies,\n  } = config;\n  const unconstrainedValue = !!lockedVersion && is.undefined(currentValue);\n  const res: UpdateResult = {\n    updates: [],\n    warnings: [],\n  } as any;\n  try {\n    logger.trace({ dependency: depName, currentValue }, 'lookupUpdates');\n    // Use the datasource's default versioning if none is configured\n    config.versioning ??= getDefaultVersioning(datasource);\n    const versioning = allVersioning.get(config.versioning);\n    res.versioning = config.versioning;\n    // istanbul ignore if\n    if (\n      !isGetPkgReleasesConfig(config) ||\n      !getDatasourceList().includes(datasource)\n    ) {\n      res.skipReason = 'invalid-config';\n      return res;\n    }\n    const isValid = is.string(currentValue) && versioning.isValid(currentValue);\n    if (unconstrainedValue || isValid) {\n      if (\n        !updatePinnedDependencies &&\n        // TODO #7154\n        versioning.isSingleVersion(currentValue!)\n      ) {\n        res.skipReason = 'is-pinned';\n        return res;\n      }\n\n      config = mergeConfigConstraints(config);\n\n      const dependency = clone(await getPkgReleases(config));\n      if (!dependency) {\n        // If dependency lookup fails then warn and return\n        const warning: ValidationMessage = {\n          topic: depName,\n          message: `Failed to look up dependency ${depName}`,\n        };\n        logger.debug({ dependency: depName, packageFile }, warning.message);\n        // TODO: return warnings in own field\n        res.warnings.push(warning);\n        return res;\n      }\n      if (dependency.deprecationMessage) {\n        logger.debug({ dependency: depName }, 'Found deprecationMessage');\n        res.deprecationMessage = dependency.deprecationMessage;\n      }\n\n      res.sourceUrl = dependency?.sourceUrl;\n      if (dependency.sourceDirectory) {\n        res.sourceDirectory = dependency.sourceDirectory;\n      }\n      res.homepage = dependency.homepage;\n      res.changelogUrl = dependency.changelogUrl;\n      res.dependencyUrl = dependency?.dependencyUrl;\n\n      const latestVersion = dependency.tags?.latest;\n      // Filter out any results from datasource that don't comply with our versioning\n      let allVersions = dependency.releases.filter((release) =>\n        versioning.isVersion(release.version)\n      );\n\n      // istanbul ignore if\n      if (allVersions.length === 0) {\n        const message = `Found no results from datasource that look like a version`;\n        logger.debug({ dependency: depName, result: dependency }, message);\n        if (!currentDigest) {\n          return res;\n        }\n      }\n      // Reapply package rules in case we missed something from sourceUrl\n      config = applyPackageRules({ ...config, sourceUrl: res.sourceUrl });\n      if (followTag) {\n        const taggedVersion = dependency.tags?.[followTag];\n        if (!taggedVersion) {\n          res.warnings.push({\n            topic: depName,\n            message: `Can't find version with tag ${followTag} for ${depName}`,\n          });\n          return res;\n        }\n        allVersions = allVersions.filter(\n          (v) =>\n            v.version === taggedVersion ||\n            (v.version === currentValue &&\n              versioning.isGreaterThan(taggedVersion, currentValue))\n        );\n      }\n      // Check that existing constraint can be satisfied\n      const allSatisfyingVersions = allVersions.filter(\n        (v) =>\n          // TODO #7154\n          unconstrainedValue || versioning.matches(v.version, currentValue!)\n      );\n      if (rollbackPrs && !allSatisfyingVersions.length) {\n        const rollback = getRollbackUpdate(config, allVersions, versioning);\n        // istanbul ignore if\n        if (!rollback) {\n          res.warnings.push({\n            topic: depName,\n            // TODO: types (#7154)\n            message: `Can't find version matching ${currentValue!} for ${depName}`,\n          });\n          return res;\n        }\n        res.updates.push(rollback);\n      }\n      let rangeStrategy = getRangeStrategy(config);\n      if (dependency.replacementName && dependency.replacementVersion) {\n        res.updates.push({\n          updateType: 'replacement',\n          newName: dependency.replacementName,\n          newValue: versioning.getNewValue({\n            // TODO #7154\n            currentValue: currentValue!,\n            newVersion: dependency.replacementVersion,\n            rangeStrategy: rangeStrategy!,\n          })!,\n        });\n      }\n      // istanbul ignore next\n      if (\n        isVulnerabilityAlert &&\n        rangeStrategy === 'update-lockfile' &&\n        !lockedVersion\n      ) {\n        rangeStrategy = 'bump';\n      }\n      const nonDeprecatedVersions = dependency.releases\n        .filter((release) => !release.isDeprecated)\n        .map((release) => release.version);\n      let currentVersion: string;\n      if (rangeStrategy === 'update-lockfile') {\n        currentVersion = lockedVersion!;\n      }\n      // TODO #7154\n      currentVersion ??=\n        getCurrentVersion(\n          currentValue!,\n          lockedVersion!,\n          versioning,\n          rangeStrategy!,\n          latestVersion!,\n          nonDeprecatedVersions\n        ) ??\n        getCurrentVersion(\n          currentValue!,\n          lockedVersion!,\n          versioning,\n          rangeStrategy!,\n          latestVersion!,\n          allVersions.map((v) => v.version)\n        )!;\n      // istanbul ignore if\n      if (!currentVersion! && lockedVersion) {\n        return res;\n      }\n      res.currentVersion = currentVersion!;\n      if (\n        currentValue &&\n        // TODO #7154\n        currentVersion! &&\n        rangeStrategy === 'pin' &&\n        !versioning.isSingleVersion(currentValue)\n      ) {\n        res.updates.push({\n          updateType: 'pin',\n          isPin: true,\n          newValue: versioning.getNewValue({\n            currentValue,\n            rangeStrategy,\n            currentVersion,\n            newVersion: currentVersion,\n          })!,\n          newMajor: versioning.getMajor(currentVersion)!,\n        });\n      }\n      // istanbul ignore if\n      if (!versioning.isVersion(currentVersion!)) {\n        res.skipReason = 'invalid-version';\n        return res;\n      }\n      // Filter latest, unstable, etc\n      // TODO #7154\n      let filteredReleases = filterVersions(\n        config,\n        currentVersion!,\n        latestVersion!,\n        allVersions,\n        versioning\n      ).filter(\n        (v) =>\n          // Leave only compatible versions\n          unconstrainedValue || versioning.isCompatible(v.version, currentValue)\n      );\n      if (isVulnerabilityAlert) {\n        filteredReleases = filteredReleases.slice(0, 1);\n      }\n      const buckets: Record<string, [Release]> = {};\n      for (const release of filteredReleases) {\n        const bucket = getBucket(\n          config,\n          // TODO #7154\n          currentVersion!,\n          release.version,\n          versioning\n        );\n        if (is.string(bucket)) {\n          if (buckets[bucket]) {\n            buckets[bucket].push(release);\n          } else {\n            buckets[bucket] = [release];\n          }\n        }\n      }\n      const depResultConfig = mergeChildConfig(config, res);\n      for (const [bucket, releases] of Object.entries(buckets)) {\n        const sortedReleases = releases.sort((r1, r2) =>\n          versioning.sortVersions(r1.version, r2.version)\n        );\n        const { release, pendingChecks, pendingReleases } =\n          await filterInternalChecks(\n            depResultConfig,\n            versioning,\n            bucket,\n            sortedReleases\n          );\n        // istanbul ignore next\n        if (!release) {\n          return res;\n        }\n        const newVersion = release.version;\n        const update = generateUpdate(\n          config,\n          versioning,\n          // TODO #7154\n\n          rangeStrategy!,\n          lockedVersion ?? currentVersion!,\n          bucket,\n          release\n        );\n        if (pendingChecks) {\n          update.pendingChecks = pendingChecks;\n        }\n\n        // TODO #7154\n        if (pendingReleases!.length) {\n          update.pendingVersions = pendingReleases!.map((r) => r.version);\n        }\n        if (!update.newValue || update.newValue === currentValue) {\n          if (!lockedVersion) {\n            continue;\n          }\n          // istanbul ignore if\n          if (rangeStrategy === 'bump') {\n            logger.trace(\n              { depName, currentValue, lockedVersion, newVersion },\n              'Skipping bump because newValue is the same'\n            );\n            continue;\n          }\n          res.isSingleVersion = true;\n        }\n        res.isSingleVersion =\n          !!res.isSingleVersion ||\n          !!versioning.isSingleVersion(update.newValue);\n\n        res.updates.push(update);\n      }\n    } else if (currentValue) {\n      logger.debug(\n        `Dependency ${depName} has unsupported value ${currentValue}`\n      );\n      if (!pinDigests && !currentDigest) {\n        res.skipReason = 'invalid-value';\n      } else {\n        delete res.skipReason;\n      }\n    } else {\n      res.skipReason = 'invalid-value';\n    }\n\n    // Record if the dep is fixed to a version\n    if (lockedVersion) {\n      res.currentVersion = lockedVersion;\n      res.fixedVersion = lockedVersion;\n    } else if (currentValue && versioning.isSingleVersion(currentValue)) {\n      res.fixedVersion = currentValue.replace(regEx(/^=+/), '');\n    }\n    // Add digests if necessary\n    if (supportsDigests(config.datasource)) {\n      if (currentDigest) {\n        if (!digestOneAndOnly || !res.updates.length) {\n          // digest update\n          res.updates.push({\n            updateType: 'digest',\n            // TODO #7154\n            newValue: currentValue!,\n          });\n        }\n      } else if (pinDigests) {\n        // Create a pin only if one doesn't already exists\n        if (!res.updates.some((update) => update.updateType === 'pin')) {\n          // pin digest\n          res.updates.push({\n            isPinDigest: true,\n            updateType: 'pinDigest',\n            // TODO #7154\n            newValue: currentValue!,\n          });\n        }\n      }\n      if (versioning.valueToVersion) {\n        // TODO #7154\n        res.currentVersion = versioning.valueToVersion(res.currentVersion!);\n        for (const update of res.updates || []) {\n          // TODO #7154\n          update.newVersion = versioning.valueToVersion(update.newVersion!);\n        }\n      }\n      // update digest for all\n      for (const update of res.updates) {\n        if (pinDigests || currentDigest) {\n          // TODO #7154\n          update.newDigest =\n            update.newDigest ?? (await getDigest(config, update.newValue))!;\n        }\n      }\n    }\n    if (res.updates.length) {\n      delete res.skipReason;\n    }\n    // Strip out any non-changed ones\n    res.updates = res.updates\n      .filter((update) => update.newDigest !== null)\n      .filter(\n        (update) =>\n          update.newValue !== currentValue ||\n          update.isLockfileUpdate ||\n          // TODO #7154\n          (update.newDigest && !update.newDigest.startsWith(currentDigest!))\n      );\n    // If range strategy specified in config is 'in-range-only', also strip out updates where currentValue !== newValue\n    if (config.rangeStrategy === 'in-range-only') {\n      res.updates = res.updates.filter(\n        (update) => update.newValue === currentValue\n      );\n    }\n    // Handle a weird edge case involving followTag and fallbacks\n    if (rollbackPrs && followTag) {\n      res.updates = res.updates.filter(\n        (update) => res.updates.length === 1 || update.updateType !== 'rollback'\n      );\n    }\n  } catch (err) /* istanbul ignore next */ {\n    if (err instanceof ExternalHostError || err.message === CONFIG_VALIDATION) {\n      throw err;\n    }\n    logger.error(\n      {\n        currentDigest,\n        currentValue,\n        datasource,\n        depName,\n        digestOneAndOnly,\n        followTag,\n        lockedVersion,\n        packageFile,\n        pinDigests,\n        rollbackPrs,\n        isVulnerabilityAlert,\n        updatePinnedDependencies,\n        unconstrainedValue,\n        err,\n      },\n      'lookupUpdates error'\n    );\n    res.skipReason = 'internal-error';\n  }\n  return res;\n}\n"]}
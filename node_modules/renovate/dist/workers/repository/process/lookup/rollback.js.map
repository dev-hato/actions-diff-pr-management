{"version":3,"file":"rollback.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/process/lookup/rollback.ts"],"names":[],"mappings":";;;AAAA,+CAA4C;AAM5C,SAAgB,iBAAiB,CAC/B,MAAsB,EACtB,QAAmB,EACnB,OAAsB;IAEtB,MAAM,EAAE,WAAW,EAAE,UAAU,EAAE,OAAO,EAAE,YAAY,EAAE,GAAG,MAAM,CAAC;IAClE,qBAAqB;IACrB,IAAI,CAAC,CAAC,iBAAiB,IAAI,OAAO,CAAC,EAAE;QACnC,eAAM,CAAC,KAAK,CACV,EAAE,UAAU,EAAE,EACd,uDAAuD,CACxD,CAAC;QACF,OAAO,IAAI,CAAC;KACb;IACD,MAAM,gBAAgB,GAAG,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE;IAC7C,aAAa;IACb,OAAO,CAAC,eAAgB,CAAC,CAAC,CAAC,OAAO,EAAE,YAAa,CAAC,CACnD,CAAC;IACF,qBAAqB;IACrB,IAAI,CAAC,gBAAgB,CAAC,MAAM,EAAE;QAC5B,eAAM,CAAC,KAAK,CACV,EAAE,WAAW,EAAE,OAAO,EAAE,YAAY,EAAE,EACtC,6CAA6C,CAC9C,CAAC;QACF,OAAO,IAAI,CAAC;KACb;IACD,eAAM,CAAC,KAAK,CACV,EAAE,WAAW,EAAE,OAAO,EAAE,YAAY,EAAE,EACtC,0CAA0C,CAC3C,CAAC;IACF,eAAM,CAAC,KAAK,CACV,EAAE,UAAU,EAAE,OAAO,EAAE,QAAQ,EAAE,EACjC,oCAAoC,CACrC,CAAC;IAEF,gBAAgB,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;IAC5E,IAAI,UAAU,CAAC;IACf,IAAI,YAAY,IAAI,OAAO,CAAC,QAAQ,CAAC,YAAY,CAAC,EAAE;QAClD,UAAU,GAAG,gBAAgB;aAC1B,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;aAC1C,GAAG,EAAE,EAAE,OAAO,CAAC;KACnB;IACD,IAAI,CAAC,UAAU,EAAE;QACf,UAAU,GAAG,gBAAgB,CAAC,GAAG,EAAE,EAAE,OAAO,CAAC;KAC9C;IACD,qBAAqB;IACrB,IAAI,CAAC,UAAU,EAAE;QACf,eAAM,CAAC,KAAK,CAAC,+BAA+B,CAAC,CAAC;QAC9C,OAAO,IAAI,CAAC;KACb;IACD,MAAM,QAAQ,GAAG,OAAO,CAAC,WAAW,CAAC;QACnC,aAAa;QACb,YAAY,EAAE,YAAa;QAC3B,aAAa,EAAE,SAAS;QACxB,UAAU;KACX,CAAC,CAAC;IACH,OAAO;QACL,MAAM,EAAE,UAAU;QAClB,aAAa;QACb,QAAQ,EAAE,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAE;QACvC,QAAQ,EAAE,QAAS;QACnB,UAAU;QACV,UAAU,EAAE,UAAU;KACvB,CAAC;AACJ,CAAC;AAhED,8CAgEC","sourcesContent":["import { logger } from '../../../../logger';\nimport type { Release } from '../../../../modules/datasource/types';\nimport type { LookupUpdate } from '../../../../modules/manager/types';\nimport type { VersioningApi } from '../../../../modules/versioning';\nimport type { RollbackConfig } from './types';\n\nexport function getRollbackUpdate(\n  config: RollbackConfig,\n  versions: Release[],\n  version: VersioningApi\n): LookupUpdate | null {\n  const { packageFile, versioning, depName, currentValue } = config;\n  // istanbul ignore if\n  if (!('isLessThanRange' in version)) {\n    logger.debug(\n      { versioning },\n      'Current versioning does not support isLessThanRange()'\n    );\n    return null;\n  }\n  const lessThanVersions = versions.filter((v) =>\n    // TODO #7154\n    version.isLessThanRange!(v.version, currentValue!)\n  );\n  // istanbul ignore if\n  if (!lessThanVersions.length) {\n    logger.debug(\n      { packageFile, depName, currentValue },\n      'Missing version has nothing to roll back to'\n    );\n    return null;\n  }\n  logger.debug(\n    { packageFile, depName, currentValue },\n    `Current version not found - rolling back`\n  );\n  logger.debug(\n    { dependency: depName, versions },\n    'Versions found before rolling back'\n  );\n\n  lessThanVersions.sort((a, b) => version.sortVersions(a.version, b.version));\n  let newVersion;\n  if (currentValue && version.isStable(currentValue)) {\n    newVersion = lessThanVersions\n      .filter((v) => version.isStable(v.version))\n      .pop()?.version;\n  }\n  if (!newVersion) {\n    newVersion = lessThanVersions.pop()?.version;\n  }\n  // istanbul ignore if\n  if (!newVersion) {\n    logger.debug('No newVersion to roll back to');\n    return null;\n  }\n  const newValue = version.getNewValue({\n    // TODO #7154\n    currentValue: currentValue!,\n    rangeStrategy: 'replace',\n    newVersion,\n  });\n  return {\n    bucket: 'rollback',\n    // TODO #7154\n    newMajor: version.getMajor(newVersion)!,\n    newValue: newValue!,\n    newVersion,\n    updateType: 'rollback',\n  };\n}\n"]}
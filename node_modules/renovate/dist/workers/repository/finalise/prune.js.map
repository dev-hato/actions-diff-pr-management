{"version":3,"file":"prune.js","sourceRoot":"","sources":["../../../../lib/workers/repository/finalise/prune.ts"],"names":[],"mappings":"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","sourcesContent":["import { GlobalConfig } from '../../../config/global';\nimport type { RenovateConfig } from '../../../config/types';\nimport { REPOSITORY_CHANGED } from '../../../constants/error-messages';\nimport { logger } from '../../../logger';\nimport { platform } from '../../../modules/platform';\nimport { ensureComment } from '../../../modules/platform/comment';\nimport { PrState } from '../../../types';\nimport {\n  deleteBranch,\n  getBranchList,\n  isBranchModified,\n} from '../../../util/git';\n\nasync function cleanUpBranches(\n  { pruneStaleBranches: enabled }: RenovateConfig,\n  remainingBranches: string[]\n): Promise<void> {\n  if (enabled === false) {\n    logger.debug('Branch/PR pruning is disabled - skipping');\n    return;\n  }\n  for (const branchName of remainingBranches) {\n    try {\n      const pr = await platform.findPr({\n        branchName,\n        state: PrState.Open,\n      });\n      const branchIsModified = await isBranchModified(branchName);\n      if (pr) {\n        if (branchIsModified) {\n          logger.debug(\n            { prNo: pr.number, prTitle: pr.title },\n            'Branch is modified - skipping PR autoclosing'\n          );\n          if (GlobalConfig.get('dryRun')) {\n            logger.info(`DRY-RUN: Would add Autoclosing Skipped comment to PR`);\n          } else {\n            await ensureComment({\n              number: pr.number,\n              topic: 'Autoclosing Skipped',\n              content:\n                'This PR has been flagged for autoclosing, however it is being skipped due to the branch being already modified. Please close/delete it manually or report a bug if you think this is in error.',\n            });\n          }\n        } else if (GlobalConfig.get('dryRun')) {\n          logger.info(\n            { prNo: pr.number, prTitle: pr.title },\n            `DRY-RUN: Would autoclose PR`\n          );\n        } else {\n          logger.info(\n            { branchName, prNo: pr.number, prTitle: pr.title },\n            'Autoclosing PR'\n          );\n          let newPrTitle = pr.title;\n          if (!pr.title.endsWith('- autoclosed')) {\n            newPrTitle += ' - autoclosed';\n          }\n          await platform.updatePr({\n            number: pr.number,\n            prTitle: newPrTitle,\n            state: PrState.Closed,\n          });\n          await deleteBranch(branchName);\n        }\n      } else if (branchIsModified) {\n        logger.debug('Orphan Branch is modified - skipping branch deletion');\n      } else if (GlobalConfig.get('dryRun')) {\n        logger.info(`DRY-RUN: Would delete orphan branch ${branchName}`);\n      } else {\n        logger.info({ branch: branchName }, `Deleting orphan branch`);\n        await deleteBranch(branchName);\n      }\n    } catch (err) /* istanbul ignore next */ {\n      if (err.message === 'config-validation') {\n        logger.debug(\n          'Cannot prune branch due to collision between tags and branch names'\n        );\n      } else if (err.message?.includes(\"bad revision 'origin/\")) {\n        logger.debug(\n          { branchName },\n          'Branch not found on origin when attempting to prune'\n        );\n      } else if (err.message !== REPOSITORY_CHANGED) {\n        logger.warn({ err, branch: branchName }, 'Error pruning branch');\n      }\n    }\n  }\n}\n\nexport async function pruneStaleBranches(\n  config: RenovateConfig,\n  branchList: string[] | null | undefined\n): Promise<void> {\n  logger.debug('Removing any stale branches');\n  logger.trace({ config }, `pruneStaleBranches`);\n  // TODO: types (#7154)\n  logger.debug(`config.repoIsOnboarded=${config.repoIsOnboarded!}`);\n  if (!branchList) {\n    logger.debug('No branchList');\n    return;\n  }\n  // TODO: types (#7154)\n  let renovateBranches = getBranchList().filter((branchName) =>\n    branchName.startsWith(config.branchPrefix!)\n  );\n  if (!renovateBranches?.length) {\n    logger.debug('No renovate branches found');\n    return;\n  }\n  logger.debug(\n    {\n      branchList: branchList?.sort(),\n      renovateBranches: renovateBranches?.sort(),\n    },\n    'Branch lists'\n  );\n  // TODO: types (#7154)\n  const lockFileBranch = `${config.branchPrefix!}lock-file-maintenance`;\n  renovateBranches = renovateBranches.filter(\n    (branch) => branch !== lockFileBranch\n  );\n  const remainingBranches = renovateBranches.filter(\n    (branch) => !branchList.includes(branch)\n  );\n  logger.debug(`remainingBranches=${String(remainingBranches)}`);\n  if (remainingBranches.length === 0) {\n    logger.debug('No branches to clean up');\n    return;\n  }\n\n  await cleanUpBranches(config, remainingBranches);\n}\n"]}